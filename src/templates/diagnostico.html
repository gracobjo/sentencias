<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico del Sistema - Analizador IPP/INSS</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/static/style.css" rel="stylesheet">
    
    <style>
        .status-card {
            transition: all 0.3s ease;
            border-left: 4px solid #dee2e6;
        }
        
        .status-card.success {
            border-left-color: #198754;
            background: linear-gradient(135deg, #d1e7dd 0%, #f8f9fa 100%);
        }
        
        .status-card.warning {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #f8f9fa 100%);
        }
        
        .status-card.danger {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f8f9fa 100%);
        }
        
        .status-card.info {
            border-left-color: #0dcaf0;
            background: linear-gradient(135deg, #d1ecf1 0%, #f8f9fa 100%);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-indicator.success { background-color: #198754; }
        .status-indicator.warning { background-color: #ffc107; }
        .status-indicator.danger { background-color: #dc3545; }
        .status-indicator.info { background-color: #0dcaf0; }
        
        .feature-list {
            list-style: none;
            padding-left: 0;
        }
        
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .feature-list li:last-child {
            border-bottom: none;
        }
        
        .progress-custom {
            height: 8px;
            border-radius: 4px;
        }
        
        .metric-card {
            text-align: center;
            padding: 1.5rem;
            border-radius: 10px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0d6efd;
        }
        
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-shield-check me-2"></i>
                Analizador IPP/INSS
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-house me-1"></i>Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/subir">
                            <i class="bi bi-upload me-1"></i>Subir Documento
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/diagnostico">
                            <i class="bi bi-activity me-1"></i>Diagnóstico
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center">
                    <i class="bi bi-activity text-primary me-3" style="font-size: 2rem;"></i>
                    <div>
                        <h1 class="h2 mb-1">Diagnóstico del Sistema</h1>
                        <p class="text-muted mb-0">Estado completo de todos los componentes y funcionalidades</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="totalDocs">-</div>
                    <div class="metric-label">Documentos</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="totalFrases">-</div>
                    <div class="metric-label">Frases Clave</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="modelStatus">-</div>
                    <div class="metric-label">Modelo IA</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="systemHealth">-</div>
                    <div class="metric-label">Salud Sistema</div>
                </div>
            </div>
        </div>

        <!-- Status Cards -->
        <div class="row g-4">
            <!-- Modelo IA -->
            <div class="col-md-6">
                <div class="card status-card" id="iaCard">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-robot text-primary me-2" style="font-size: 1.5rem;"></i>
                            <h5 class="card-title mb-0">Modelo de Inteligencia Artificial</h5>
                        </div>
                        <div class="mb-3">
                            <span class="status-indicator" id="iaStatus"></span>
                            <span id="iaStatusText">Verificando...</span>
                        </div>
                        <ul class="feature-list" id="iaFeatures">
                            <li><i class="bi bi-clock me-2"></i>Verificando modelo SBERT...</li>
                            <li><i class="bi bi-clock me-2"></i>Verificando modelo TF-IDF...</li>
                            <li><i class="bi bi-clock me-2"></i>Verificando clasificador...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Análisis de Documentos -->
            <div class="col-md-6">
                <div class="card status-card" id="analysisCard">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-file-text text-success me-2" style="font-size: 1.5rem;"></i>
                            <h5 class="card-title mb-0">Análisis de Documentos</h5>
                        </div>
                        <div class="mb-3">
                            <span class="status-indicator" id="analysisStatus"></span>
                            <span id="analysisStatusText">Verificando...</span>
                        </div>
                        <ul class="feature-list" id="analysisFeatures">
                            <li><i class="bi bi-clock me-2"></i>Verificando extracción de texto...</li>
                            <li><i class="bi bi-clock me-2"></i>Verificando análisis de frases clave...</li>
                            <li><i class="bi bi-clock me-2"></i>Verificando extracción de argumentos...</li>
                            <li><i class="bi bi-clock me-2"></i>Verificando generación de insights...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Generación de Demandas -->
            <div class="col-md-6">
                <div class="card status-card" id="demandCard">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-file-earmark-text text-warning me-2" style="font-size: 1.5rem;"></i>
                            <h5 class="card-title mb-0">Generación de Demandas</h5>
                        </div>
                        <div class="mb-3">
                            <span class="status-indicator" id="demandStatus"></span>
                            <span id="demandStatusText">Verificando...</span>
                        </div>
                        <ul class="feature-list" id="demandFeatures">
                            <li><i class="bi bi-clock me-2"></i>Verificando extracción de fallos...</li>
                            <li><i class="bi bi-clock me-2"></i>Verificando extracción de fundamentos...</li>
                            <li><i class="bi bi-clock me-2"></i>Verificando generación TXT...</li>
                            <li><i class="bi bi-clock me-2"></i>Verificando generación DOCX...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Sistema de Archivos -->
            <div class="col-md-6">
                <div class="card status-card" id="filesCard">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-folder text-info me-2" style="font-size: 1.5rem;"></i>
                            <h5 class="card-title mb-0">Sistema de Archivos</h5>
                        </div>
                        <div class="mb-3">
                            <span class="status-indicator" id="filesStatus"></span>
                            <span id="filesStatusText">Verificando...</span>
                        </div>
                        <ul class="feature-list" id="filesFeatures">
                            <li><i class="bi bi-clock me-2"></i>Verificando directorio sentencias...</li>
                            <li><i class="bi bi-clock me-2"></i>Verificando directorio uploads...</li>
                            <li><i class="bi bi-clock me-2"></i>Verificando directorio models...</li>
                            <li><i class="bi bi-clock me-2"></i>Verificando permisos de escritura...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up me-2"></i>
                            Análisis Detallado
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Documentos Disponibles</h6>
                                <div id="documentsList" class="mb-3">
                                    <div class="text-muted">Cargando...</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Frases Clave Encontradas</h6>
                                <div id="phrasesList" class="mb-3">
                                    <div class="text-muted">Cargando...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <button class="btn btn-primary me-2" onclick="runFullDiagnostic()">
                    <i class="bi bi-arrow-clockwise me-2"></i>
                    Ejecutar Diagnóstico Completo
                </button>
                <button class="btn btn-outline-secondary me-2" onclick="testAnalysis()">
                    <i class="bi bi-play-circle me-2"></i>
                    Probar Análisis
                </button>
                <button class="btn btn-outline-info" onclick="exportDiagnostic()">
                    <i class="bi bi-download me-2"></i>
                    Exportar Reporte
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-5">
        <div class="container text-center">
            <p class="text-muted mb-0">
                <i class="bi bi-c-circle me-1"></i>
                2024 Analizador IPP/INSS - Diagnóstico del Sistema
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Diagnostic functions
        async function runFullDiagnostic() {
            console.log('Ejecutando diagnóstico completo...');
            
            // Update UI to show loading
            document.querySelectorAll('.status-indicator').forEach(el => {
                el.className = 'status-indicator info';
            });
            document.querySelectorAll('.status-card').forEach(el => {
                el.className = 'card status-card info';
            });
            
            try {
                // Test health endpoint
                const healthResponse = await fetch('/health');
                const healthData = await healthResponse.json();
                updateHealthStatus(healthData);
                
                // Test IA diagnostic endpoint
                const iaResponse = await fetch('/api/diagnostico/ia');
                const iaData = await iaResponse.json();
                updateIAStatus(iaData);
                
                // Test analysis endpoint
                const analysisResponse = await fetch('/api/analizar');
                const analysisData = await analysisResponse.json();
                updateAnalysisStatus(analysisData);
                
                // Test documents endpoint
                const docsResponse = await fetch('/api/documentos');
                const docsData = await docsResponse.json();
                updateDocumentsStatus(docsData);
                
                // Test demand generation
                await testDemandGeneration();
                
                // Update metrics
                updateMetrics(healthData, analysisData, docsData, iaData);
                
            } catch (error) {
                console.error('Error en diagnóstico:', error);
                showError('Error al ejecutar el diagnóstico');
            }
        }
        
        function updateIAStatus(data) {
            const card = document.getElementById('iaCard');
            const status = document.getElementById('iaStatus');
            const statusText = document.getElementById('iaStatusText');
            const features = document.getElementById('iaFeatures');
            
            if (data.error) {
                card.className = 'card status-card danger';
                status.className = 'status-indicator danger';
                statusText.textContent = 'Error en IA';
                features.innerHTML = `<li><i class="bi bi-x-circle-fill text-danger me-2"></i>Error: ${data.error}</li>`;
                return;
            }
            
            const modeloActivo = data.modelo_activo;
            const modelos = data.modelos;
            
            if (modeloActivo === "SBERT Real") {
                card.className = 'card status-card success';
                status.className = 'status-indicator success';
                statusText.textContent = 'SBERT Real Activo';
                
                features.innerHTML = `
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Modelo SBERT: Cargado</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Encoder SBERT: Funcionando</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Clasificador: Activo</li>
                `;
            } else if (modeloActivo === "TF-IDF Fallback") {
                card.className = 'card status-card warning';
                status.className = 'status-indicator warning';
                statusText.textContent = 'TF-IDF Fallback';
                
                features.innerHTML = `
                    <li><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>Modelo SBERT: No disponible</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>TF-IDF Fallback: Activo</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Clasificador: Funcionando</li>
                `;
            } else if (modeloActivo === "TF-IDF") {
                card.className = 'card status-card info';
                status.className = 'status-indicator info';
                statusText.textContent = 'TF-IDF Original';
                
                features.innerHTML = `
                    <li><i class="bi bi-info-circle-fill text-info me-2"></i>Modelo TF-IDF: Cargado</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Vectorizador: Activo</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Clasificador: Funcionando</li>
                `;
            } else {
                card.className = 'card status-card danger';
                status.className = 'status-indicator danger';
                statusText.textContent = 'Análisis por Reglas';
                
                features.innerHTML = `
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i>Modelos IA: No disponibles</li>
                    <li><i class="bi bi-info-circle-fill text-info me-2"></i>Análisis básico: Activo</li>
                `;
            }
        }
        
        function updateHealthStatus(data) {
            const card = document.getElementById('filesCard');
            const status = document.getElementById('filesStatus');
            const statusText = document.getElementById('filesStatusText');
            const features = document.getElementById('filesFeatures');
            
            if (data.status === 'ok') {
                card.className = 'card status-card success';
                status.className = 'status-indicator success';
                statusText.textContent = 'Sistema Operativo';
                
                features.innerHTML = `
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Directorio sentencias: OK</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Directorio uploads: OK</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Directorio models: OK</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Permisos de escritura: OK</li>
                `;
            } else {
                card.className = 'card status-card danger';
                status.className = 'status-indicator danger';
                statusText.textContent = 'Error en Sistema';
            }
        }
        
        function updateAnalysisStatus(data) {
            const card = document.getElementById('analysisCard');
            const status = document.getElementById('analysisStatus');
            const statusText = document.getElementById('analysisStatusText');
            const features = document.getElementById('analysisFeatures');
            
            if (data.archivos_analizados > 0) {
                card.className = 'card status-card success';
                status.className = 'status-indicator success';
                statusText.textContent = 'Análisis Funcionando';
                
                features.innerHTML = `
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Extracción de texto: OK</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Análisis de frases clave: OK (${data.total_apariciones} encontradas)</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Extracción de argumentos: OK</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Generación de insights: OK</li>
                `;
            } else {
                card.className = 'card status-card warning';
                status.className = 'status-indicator warning';
                statusText.textContent = 'Sin Documentos';
            }
        }
        
        function updateDocumentsStatus(data) {
            const documentsList = document.getElementById('documentsList');
            const phrasesList = document.getElementById('phrasesList');
            
            if (data.documentos && data.documentos.length > 0) {
                documentsList.innerHTML = data.documentos.slice(0, 5).map(doc => 
                    `<div class="mb-1"><i class="bi bi-file-text me-2"></i>${doc.nombre}</div>`
                ).join('');
                if (data.documentos.length > 5) {
                    documentsList.innerHTML += `<div class="text-muted">... y ${data.documentos.length - 5} más</div>`;
                }
            } else {
                documentsList.innerHTML = '<div class="text-muted">No hay documentos</div>';
            }
        }
        
        async function testDemandGeneration() {
            const card = document.getElementById('demandCard');
            const status = document.getElementById('demandStatus');
            const statusText = document.getElementById('demandStatusText');
            const features = document.getElementById('demandFeatures');
            
            try {
                // Primero obtener lista de documentos disponibles
                const docsResponse = await fetch('/api/documentos');
                const docsData = await docsResponse.json();
                
                if (!docsData.documentos || docsData.documentos.length === 0) {
                    card.className = 'card status-card warning';
                    status.className = 'status-indicator warning';
                    statusText.textContent = 'Sin Documentos';
                    
                    features.innerHTML = `
                        <li><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>No hay documentos para probar</li>
                        <li><i class="bi bi-info-circle-fill text-info me-2"></i>Sube un documento para probar</li>
                    `;
                    return;
                }
                
                // Usar el primer documento disponible
                const primerDoc = docsData.documentos[0].nombre;
                
                // Test demand extraction
                const extractResponse = await fetch('/api/extract/demanda', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        nombres_archivo: [primerDoc]
                    })
                });
                
                if (extractResponse.ok) {
                    const extractData = await extractResponse.json();
                    
                    // Test TXT generation
                    const txtResponse = await fetch('/api/demanda-base/txt', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            nombres_archivo: [primerDoc],
                            meta: {}
                        })
                    });
                    
                    // Test DOCX generation
                    const docxResponse = await fetch('/api/demanda-base/docx', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            nombres_archivo: [primerDoc],
                            meta: {}
                        })
                    });
                    
                    card.className = 'card status-card success';
                    status.className = 'status-indicator success';
                    statusText.textContent = 'Generación Funcionando';
                    
                    features.innerHTML = `
                        <li><i class="bi bi-check-circle-fill text-success me-2"></i>Extracción de fallos: OK</li>
                        <li><i class="bi bi-check-circle-fill text-success me-2"></i>Extracción de fundamentos: OK</li>
                        <li><i class="bi bi-check-circle-fill text-success me-2"></i>Generación TXT: ${txtResponse.ok ? 'OK' : 'Error'}</li>
                        <li><i class="bi bi-check-circle-fill text-success me-2"></i>Generación DOCX: ${docxResponse.ok ? 'OK' : 'Error'}</li>
                    `;
                } else {
                    throw new Error('Error en extracción');
                }
            } catch (error) {
                card.className = 'card status-card danger';
                status.className = 'status-indicator danger';
                statusText.textContent = 'Error en Generación';
                
                features.innerHTML = `
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i>Error en extracción: ${error.message}</li>
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i>Error en generación</li>
                `;
            }
        }
        
        function updateMetrics(healthData, analysisData, docsData, iaData) {
            document.getElementById('totalDocs').textContent = docsData.documentos ? docsData.documentos.length : 0;
            document.getElementById('totalFrases').textContent = analysisData.total_apariciones || 0;
            document.getElementById('modelStatus').textContent = iaData.modelo_activo || 'Desconocido';
            document.getElementById('systemHealth').textContent = healthData.status === 'ok' ? 'OK' : 'Error';
            
            // Actualizar lista de frases clave si está disponible
            const phrasesList = document.getElementById('phrasesList');
            if (analysisData.resultados_por_archivo) {
                const todasLasFrases = new Set();
                Object.values(analysisData.resultados_por_archivo).forEach(archivo => {
                    if (archivo.frases_clave) {
                        Object.keys(archivo.frases_clave).forEach(frase => {
                            todasLasFrases.add(frase);
                        });
                    }
                });
                
                if (todasLasFrases.size > 0) {
                    phrasesList.innerHTML = Array.from(todasLasFrases).slice(0, 10).map(frase => 
                        `<div class="mb-1"><i class="bi bi-tag me-2"></i>${frase}</div>`
                    ).join('');
                    if (todasLasFrases.size > 10) {
                        phrasesList.innerHTML += `<div class="text-muted">... y ${todasLasFrases.size - 10} más</div>`;
                    }
                } else {
                    phrasesList.innerHTML = '<div class="text-muted">No hay frases clave encontradas</div>';
                }
            } else {
                phrasesList.innerHTML = '<div class="text-muted">No hay datos de análisis</div>';
            }
        }
        
        function testAnalysis() {
            // Redirect to analysis page
            window.location.href = '/api/analizar';
        }
        
        function exportDiagnostic() {
            // Create diagnostic report
            const report = {
                timestamp: new Date().toISOString(),
                system: 'Analizador IPP/INSS',
                version: '2.0.0'
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diagnostico_sistema.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function showError(message) {
            alert('Error: ' + message);
        }
        
        // Run initial diagnostic on page load
        document.addEventListener('DOMContentLoaded', function() {
            runFullDiagnostic();
        });
    </script>
</body>
</html>
