<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Resoluciones IPP/INSS</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <link href="/static/style.css" rel="stylesheet">
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-file-text me-2"></i>
                Analizador de Resoluciones IPP/INSS
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/subir">
                    <i class="bi bi-upload me-1"></i>Subir Documento
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- T√≠tulo -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-5 text-center text-primary mb-3">
                    <i class="bi bi-search me-3"></i>An√°lisis de Resoluciones Administrativas
                </h1>
                <p class="lead text-center text-muted">
                    Sistema de an√°lisis autom√°tico de resoluciones en busca de frases clave
                </p>
                
                <!-- Bot√≥n para subir archivos -->
                <div class="text-center mt-4">
                    <a href="/subir" class="btn btn-success btn-lg">
                        <i class="bi bi-upload me-2"></i>Subir Nuevo Documento
                    </a>
                </div>
            </div>
        </div>

        <!-- Botones de debug -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button class="btn btn-warning" onclick="testShowFraseDetails()">
                    <i class="bi bi-bug me-2"></i>Test: Ver Detalles
                </button>
                <button class="btn btn-info" onclick="debugFraseData()">
                    <i class="bi bi-info-circle me-2"></i>Debug: Datos Frases
                </button>
                <button class="btn btn-success" onclick="testBusquedaArgumentos()">
                    <i class="bi bi-search me-2"></i>Test: B√∫squeda Argumentos
                </button>
                <button class="btn btn-dark" onclick="verificarDatosBackend()">
                    <i class="bi bi-server me-2"></i>Verificar Backend
                </button>
                <button class="btn btn-primary" onclick="mostrarAnalisisInteligente()">
                    <i class="bi bi-brain me-2"></i>An√°lisis Inteligente
                </button>
                <button class="btn btn-danger" onclick="debugAvanzado()">
                    <i class="bi bi-exclamation-triangle me-2"></i>Debug Avanzado
                </button>
            </div>
        </div>

        <!-- Ranking Global -->
        {% if ranking_global %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-trophy me-2"></i>Ranking Global de Frases Clave
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="px-4">#</th>
                                        <th>Frase Clave</th>
                                        <th class="text-center">Apariciones</th>
                                        <th class="text-center">Porcentaje</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for frase, datos in ranking_global.items() %}
                                    <tr>
                                        <td class="px-4 fw-bold text-primary">{{ loop.index }}</td>
                                        <td>
                                            <span class="clickable-frase" 
                                                  data-frase="{{ frase }}" 
                                                  data-datos="{{ datos|tojson|safe }}">
                                                {{ frase }}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-primary fs-6">{{ datos.total }}</span>
                                        </td>
                                        <td class="text-center">
                                            {{ (datos.total / total_apariciones * 100) | round(1) }}%
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script personalizado -->
    <script>
        // Funci√≥n para mostrar notificaciones
        function mostrarNotificacion(mensaje, tipo) {
            const notificacion = document.createElement('div');
            notificacion.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
            notificacion.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notificacion.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.remove();
                }
            }, 5000);
        }

        // Funci√≥n para decodificar entidades HTML
        function decodeHtmlEntities(text) {
            if (!text || typeof text !== 'string') return text;
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }

        // Funci√≥n para parsear JSON de forma segura
        function parseJsonSafely(jsonString) {
            if (!jsonString || typeof jsonString !== 'string') {
                throw new Error('Input inv√°lido');
            }
            
            const trimmed = jsonString.trim();
            if (trimmed === '{' || trimmed === '[' || trimmed === '"') {
                throw new Error('JSON incompleto');
            }
            
            try {
                return JSON.parse(trimmed);
            } catch (e1) {
                try {
                    const decoded = decodeHtmlEntities(trimmed);
                    return JSON.parse(decoded);
                } catch (e2) {
                    throw new Error(`Error parsing JSON: ${e2.message}`);
                }
            }
        }

        // Funci√≥n para debug de datos de frases
        function debugFraseData() {
            console.log('=== DEBUG: Datos de frases ===');
            
            const elementos = document.querySelectorAll('[data-frase]');
            console.log(`Encontrados ${elementos.length} elementos con data-frase`);
            
            elementos.forEach((elemento, index) => {
                const frase = elemento.getAttribute('data-frase');
                const datos = elemento.getAttribute('data-datos');
                
                console.log(`Elemento ${index + 1}:`);
                console.log(`  Frase: ${frase}`);
                console.log(`  Datos: ${datos ? 'S√ç' : 'NO'}`);
                
                if (datos) {
                    try {
                        const parsed = parseJsonSafely(datos);
                        console.log(`  ‚úÖ Datos parseados:`, parsed);
                    } catch (e) {
                        console.error(`  ‚ùå Error parsing: ${e.message}`);
                    }
                }
                console.log('---');
            });
        }

        // Funci√≥n para probar b√∫squeda de argumentos
        function testBusquedaArgumentos() {
            console.log('=== TEST: B√∫squeda de Argumentos ===');
            mostrarNotificacion('Test de b√∫squeda ejecutado', 'info');
        }

        // Funci√≥n para verificar backend
        async function verificarDatosBackend() {
            try {
                const response = await fetch('/api/analizar');
                const data = await response.json();
                console.log('‚úÖ Backend responde:', data);
                mostrarNotificacion('Backend verificado correctamente', 'success');
            } catch (error) {
                console.error('‚ùå Error backend:', error);
                mostrarNotificacion('Error verificando backend', 'danger');
            }
        }

        // Funci√≥n para an√°lisis inteligente
        async function mostrarAnalisisInteligente() {
            try {
                const response = await fetch('/api/analizar');
                const datos = await response.json();
                console.log('‚úÖ An√°lisis inteligente:', datos);
                mostrarNotificacion('An√°lisis inteligente ejecutado', 'success');
            } catch (error) {
                console.error('‚ùå Error an√°lisis:', error);
                mostrarNotificacion('Error en an√°lisis inteligente', 'danger');
            }
        }

        // Funci√≥n para debug avanzado
        async function debugAvanzado() {
            console.log('üö® === DEBUG AVANZADO ===');
            mostrarNotificacion('Debug avanzado ejecutado', 'info');
        }

        // Funci√≥n de prueba
        function testShowFraseDetails() {
            console.log('=== TEST: showFraseDetails ===');
            mostrarNotificacion('Test ejecutado correctamente', 'success');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const clickableElements = document.querySelectorAll('.clickable-frase');
            clickableElements.forEach(function(element) {
                element.addEventListener('click', function() {
                    const frase = this.getAttribute('data-frase');
                    const datos = this.getAttribute('data-datos');
                    
                    if (frase && datos) {
                        try {
                            const parsedData = parseJsonSafely(datos);
                            console.log('Frase clickeada:', frase);
                            console.log('Datos:', parsedData);
                            mostrarNotificacion(`Frase "${frase}" clickeada`, 'info');
                        } catch (e) {
                            console.error('Error parsing datos:', e);
                            mostrarNotificacion('Error al procesar los datos', 'danger');
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>
