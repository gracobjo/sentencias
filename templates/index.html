<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Resoluciones IPP/INSS</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Estilos personalizados -->
    <link href="/static/style.css" rel="stylesheet">
    
    <style>
        .clickable-frase {
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .clickable-frase:hover {
            background-color: #e3f2fd;
            color: #1976d2;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .ranking-filters {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .frase-highlight {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 2px 6px;
            margin: 2px;
            display: inline-block;
        }
        
        .stats-card {
            transition: transform 0.2s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
        }
        
        .modal-xl {
            max-width: 90%;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .documento-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }
        
        .documento-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #007bff;
        }
        
        .documento-card .card-body {
            min-height: 120px;
        }
        
        .documento-card .card-title {
            font-size: 0.9rem;
            line-height: 1.2;
        }
        
        .text-truncate {
            max-width: 200px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-file-text me-2"></i>
                Analizador de Resoluciones IPP/INSS
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/subir">
                    <i class="bi bi-upload me-1"></i>Subir Documento
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- T√≠tulo -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-5 text-center text-primary mb-3">
                    <i class="bi bi-search me-3"></i>An√°lisis de Resoluciones Administrativas
                </h1>
                <p class="lead text-center text-muted">
                    Sistema de an√°lisis autom√°tico de resoluciones en busca de frases clave
                </p>
                
                <!-- Bot√≥n para subir archivos -->
                <div class="text-center mt-4">
                    <a href="/subir" class="btn btn-success btn-lg">
                        <i class="bi bi-upload me-2"></i>Subir Nuevo Documento
                    </a>
                </div>
            </div>
        </div>

        <!-- Botones de debug -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button class="btn btn-warning" onclick="testShowFraseDetails()">
                    <i class="bi bi-bug me-2"></i>Test: Ver Detalles
                </button>
                <button class="btn btn-info" onclick="debugFraseData()">
                    <i class="bi bi-info-circle me-2"></i>Debug: Datos Frases
                </button>
                <button class="btn btn-success" onclick="testBusquedaArgumentos()">
                    <i class="bi bi-search me-2"></i>Test: B√∫squeda Argumentos
                </button>
                <button class="btn btn-dark" onclick="verificarDatosBackend()">
                    <i class="bi bi-server me-2"></i>Verificar Backend
                </button>
                <button class="btn btn-primary" onclick="mostrarAnalisisInteligente()">
                    <i class="bi bi-brain me-2"></i>An√°lisis Inteligente
                </button>
                <button class="btn btn-danger" onclick="debugAvanzado()">
                    <i class="bi bi-exclamation-triangle me-2"></i>Debug Avanzado
                </button>
            </div>
        </div>

        <!-- Documentos Analizados -->
        {% if resultados_por_archivo %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-files me-2"></i>Documentos Analizados
                            <span class="badge bg-light text-dark ms-2">{{ resultados_por_archivo|length }} documentos</span>
                        </h5>
                        <div>
                            <button class="btn btn-light btn-sm" onclick="exportarDocumentos()">
                                <i class="bi bi-download me-1"></i>Exportar Lista
                            </button>
                            <button class="btn btn-light btn-sm" onclick="mostrarDetallesDocumentos()">
                                <i class="bi bi-info-circle me-1"></i>Ver Detalles
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for nombre_archivo, resultado in resultados_por_archivo.items() %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100 border-0 shadow-sm documento-card" 
                                     data-archivo="{{ nombre_archivo }}"
                                     onclick="mostrarDetallesDocumento('{{ nombre_archivo }}')">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center mb-2">
                                            {% if nombre_archivo.endswith('.pdf') %}
                                                <i class="bi bi-file-pdf text-danger fs-4 me-2"></i>
                                            {% elif nombre_archivo.endswith('.txt') %}
                                                <i class="bi bi-file-text text-primary fs-4 me-2"></i>
                                            {% else %}
                                                <i class="bi bi-file-earmark text-secondary fs-4 me-2"></i>
                                            {% endif %}
                                            <h6 class="card-title mb-0 text-truncate" title="{{ nombre_archivo }}">
                                                {{ nombre_archivo }}
                                            </h6>
                                        </div>
                                        
                                        {% if resultado.get('procesado') %}
                                            <div class="text-success mb-2">
                                                <i class="bi bi-check-circle me-1"></i>
                                                <small>Procesado correctamente</small>
                                            </div>
                                            {% if resultado.get('frases_clave') %}
                                                <div class="mb-2">
                                                    <small class="text-muted">
                                                        <i class="bi bi-tags me-1"></i>
                                                        {{ resultado.frases_clave|length }} categor√≠as encontradas
                                                    </small>
                                                </div>
                                                <div class="mb-2">
                                                    <small class="text-muted">
                                                        <i class="bi bi-search me-1"></i>
                                                        {{ resultado.get('total_frases', 0) }} frases clave
                                                    </small>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <div class="text-danger mb-2">
                                                <i class="bi bi-x-circle me-1"></i>
                                                <small>Error en procesamiento</small>
                                            </div>
                                            {% if resultado.get('error') %}
                                                <div class="text-danger">
                                                    <small>{{ resultado.error }}</small>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <div class="card-footer bg-transparent border-0 p-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                {% if resultado.get('procesado') %}
                                                    <i class="bi bi-clock me-1"></i>
                                                    {{ resultado.get('tiempo_procesamiento', 'N/A') }}
                                                {% endif %}
                                            </small>
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    onclick="event.stopPropagation(); verDocumento('{{ nombre_archivo }}')"
                                                    title="Ver documento">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Ranking Global -->
        {% if ranking_global %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-trophy me-2"></i>Ranking Global de Frases Clave
                        </h5>
                        <div>
                            <button class="btn btn-light btn-sm" onclick="exportarRanking()">
                                <i class="bi bi-download me-1"></i>Exportar
                            </button>
                            <button class="btn btn-light btn-sm" onclick="mostrarGraficoRanking()">
                                <i class="bi bi-graph-up me-1"></i>Gr√°fico
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros y b√∫squeda -->
                    <div class="ranking-filters">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="searchFrase" class="form-label">Buscar frase:</label>
                                <input type="text" class="form-control" id="searchFrase" placeholder="Escriba para filtrar...">
                            </div>
                            <div class="col-md-3">
                                <label for="minApariciones" class="form-label">M√≠n. apariciones:</label>
                                <input type="number" class="form-control" id="minApariciones" min="1" value="1">
                            </div>
                            <div class="col-md-3">
                                <label for="ordenRanking" class="form-label">Ordenar por:</label>
                                <select class="form-select" id="ordenRanking">
                                    <option value="total">Total apariciones</option>
                                    <option value="porcentaje">Porcentaje</option>
                                    <option value="alfabetico">Alfab√©tico</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="aplicarFiltros()">
                                    <i class="bi bi-funnel me-1"></i>Filtrar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="rankingTable">
                                <thead>
                                    <tr>
                                        <th class="px-4">#</th>
                                        <th>Frase Clave</th>
                                        <th class="text-center">Apariciones</th>
                                        <th class="text-center">Porcentaje</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for frase, datos in ranking_global.items() %}
                                    <tr class="ranking-row" data-frase="{{ frase }}" data-total="{{ datos.total }}">
                                        <td class="px-4 fw-bold text-primary">{{ loop.index }}</td>
                                        <td>
                                            <span class="clickable-frase" 
                                                  data-frase="{{ frase }}" 
                                                  data-frase-index="{{ loop.index0 }}"
                                                  onclick="mostrarDetallesFrase('{{ frase }}')">
                                                {{ frase }}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-primary fs-6">{{ datos.total }}</span>
                                        </td>
                                        <td class="text-center">
                                            {{ (datos.total / total_apariciones * 100) | round(1) }}%
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-info" onclick="mostrarDetallesFrase('{{ frase }}')" title="Ver detalles">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-success" onclick="compararFrase('{{ frase }}')" title="Comparar">
                                                    <i class="bi bi-arrow-left-right"></i>
                                                </button>
                                                <button class="btn btn-outline-warning" onclick="resaltarFrase('{{ frase }}')" title="Resaltar">
                                                    <i class="bi bi-highlighter"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Estad√≠sticas r√°pidas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card border-0 shadow-sm text-center">
                    <div class="card-body">
                        <i class="bi bi-list-ol text-primary fs-1"></i>
                        <h5 class="card-title mt-2">{{ ranking_global|length }}</h5>
                        <p class="card-text text-muted">Frases Clave</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card border-0 shadow-sm text-center">
                    <div class="card-body">
                        <i class="bi bi-file-text text-success fs-1"></i>
                        <h5 class="card-title mt-2">{{ total_apariciones }}</h5>
                        <p class="card-text text-muted">Total Apariciones</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card border-0 shadow-sm text-center">
                    <div class="card-body">
                        <i class="bi bi-graph-up text-warning fs-1"></i>
                        <h5 class="card-title mt-2">{{ (ranking_global.values() | map(attribute='total') | max) if ranking_global else 0 }}</h5>
                        <p class="card-text text-muted">M√°x. Apariciones</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card border-0 shadow-sm text-center">
                    <div class="card-body">
                        <i class="bi bi-percent text-info fs-1"></i>
                        <h5 class="card-title mt-2">{{ ((ranking_global.values() | map(attribute='total') | max) / total_apariciones * 100) | round(1) if ranking_global and total_apariciones > 0 else 0 }}%</h5>
                        <p class="card-text text-muted">Frase Dominante</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bot√≥n de An√°lisis Predictivo -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <a href="/analisis-predictivo" class="btn btn-primary btn-lg">
                    <i class="bi bi-crystal-ball me-2"></i>An√°lisis Predictivo Inteligente
                </a>
                <p class="text-muted mt-2">
                    Descubre patrones ocultos y predice resultados bas√°ndote en el an√°lisis inteligente
                </p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Modal para detalles de frase -->
    <div class="modal fade" id="fraseModal" tabindex="-1" aria-labelledby="fraseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="fraseModalLabel">
                        <i class="bi bi-info-circle me-2"></i>Detalles de Frase Clave
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="fraseModalBody">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="exportarFraseDetalle()">Exportar Detalles</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para comparaci√≥n -->
    <div class="modal fade" id="comparacionModal" tabindex="-1" aria-labelledby="comparacionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="comparacionModalLabel">
                        <i class="bi bi-arrow-left-right me-2"></i>Comparaci√≥n de Frases
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="comparacionModalBody">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles de documento -->
    <div class="modal fade" id="documentoModal" tabindex="-1" aria-labelledby="documentoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="documentoModalLabel">
                        <i class="bi bi-file-text me-2"></i>Detalles del Documento
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="documentoModalBody">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="exportarDocumentoDetalle()">Exportar Detalles</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles generales de documentos -->
    <div class="modal fade" id="documentosGeneralesModal" tabindex="-1" aria-labelledby="documentosGeneralesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="documentosGeneralesModalLabel">
                        <i class="bi bi-files me-2"></i>Resumen General de Documentos
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="documentosGeneralesModalBody">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" onclick="exportarResumenDocumentos()">Exportar Resumen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script con datos del backend -->
    <script type="application/json" id="rankingData">
        {{ ranking_global|tojson|safe }}
    </script>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script personalizado -->
    <script>
        // Variables globales
        let rankingGlobalData = null;
        let fraseSeleccionada = null;
        let fraseComparacion = null;
        
        // Funci√≥n para mostrar notificaciones
        function mostrarNotificacion(mensaje, tipo) {
            const notificacion = document.createElement('div');
            notificacion.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
            notificacion.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notificacion.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.remove();
                }
            }, 5000);
        }

        // Funci√≥n para cargar datos del ranking
        function cargarDatosRanking() {
            try {
                const scriptTag = document.getElementById('rankingData');
                if (scriptTag && scriptTag.textContent) {
                    rankingGlobalData = JSON.parse(scriptTag.textContent.trim());
                    console.log('‚úÖ Datos del ranking cargados correctamente:', rankingGlobalData);
                    return true;
                } else {
                    console.error('‚ùå No se encontr√≥ el script con datos del ranking');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error cargando datos del ranking:', error);
                return false;
            }
        }

        // Funci√≥n para mostrar detalles de una frase
        function mostrarDetallesFrase(frase) {
            if (!rankingGlobalData || !rankingGlobalData[frase]) {
                mostrarNotificacion('No hay datos disponibles para esta frase', 'warning');
                return;
            }

            fraseSeleccionada = frase;
            const datos = rankingGlobalData[frase];
            
            const modalBody = document.getElementById('fraseModalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Informaci√≥n General</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Frase:</strong></td><td>${frase}</td></tr>
                            <tr><td><strong>Total Apariciones:</strong></td><td><span class="badge bg-primary">${datos.total}</span></td></tr>
                            <tr><td><strong>Porcentaje:</strong></td><td>${((datos.total / {{ total_apariciones }}) * 100).toFixed(1)}%</td></tr>
                            <tr><td><strong>Posici√≥n Ranking:</strong></td><td>${obtenerPosicionRanking(frase)}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-success">Estad√≠sticas</h6>
                        <div class="chart-container">
                            <canvas id="fraseChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-info">Ocurrencias Detalladas</h6>
                        ${generarTablaOcurrencias(datos.ocurrencias || [])}
                    </div>
                </div>
            `;
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('fraseModal'));
            modal.show();
            
            // Crear gr√°fico despu√©s de mostrar el modal
            setTimeout(() => crearGraficoFrase(frase, datos), 100);
        }

        // Funci√≥n para ver una aparici√≥n espec√≠fica en el documento
        function verAparicionEnDocumento(documento, posicion, frase, index) {
            console.log(`üîç Navegando a aparici√≥n en ${documento}, posici√≥n ${posicion}, frase: ${frase}`);
            
            // Cerrar el modal actual
            const modal = bootstrap.Modal.getInstance(document.getElementById('fraseModal'));
            if (modal) {
                modal.hide();
            }
            
            // Mostrar notificaci√≥n de navegaci√≥n
            mostrarNotificacion(`Navegando a "${frase}" en ${documento}...`, 'info');
            
            // Navegar al documento con par√°metros para resaltar la aparici√≥n
            const url = `/archivo/${encodeURIComponent(documento)}?highlight=${encodeURIComponent(frase)}&pos=${posicion}&index=${index}`;
            window.open(url, '_blank');
        }

        // Funci√≥n para generar tabla de ocurrencias
        function generarTablaOcurrencias(ocurrencias) {
            if (!ocurrencias || ocurrencias.length === 0) {
                return '<p class="text-muted">No hay informaci√≥n detallada de ocurrencias disponible.</p>';
            }
            
            let tabla = '<div class="table-responsive"><table class="table table-sm table-striped">';
            tabla += '<thead><tr><th>Documento</th><th>Contexto</th><th>Posici√≥n</th><th>Acci√≥n</th></tr></thead><tbody>';
            
            ocurrencias.forEach((ocurrencia, index) => {
                const documento = ocurrencia.archivo || ocurrencia.documento || 'N/A';
                const contexto = ocurrencia.contexto || 'N/A';
                const posicion = ocurrencia.posicion || 'N/A';
                
                tabla += `<tr>
                    <td><strong>${documento}</strong></td>
                    <td>
                        <div class="contexto-texto" style="max-height: 60px; overflow: hidden; font-size: 0.9em;">
                            ${contexto}
                        </div>
                    </td>
                    <td><span class="badge bg-secondary">${posicion}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" 
                                onclick="verAparicionEnDocumento('${documento}', ${posicion}, '${ocurrencia.frase || ''}', ${index})"
                                title="Ver en documento">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    </td>
                </tr>`;
            });
            
            tabla += '</tbody></table></div>';
            return tabla;
        }

        // Funci√≥n para crear gr√°fico de la frase
        function crearGraficoFrase(frase, datos) {
            const ctx = document.getElementById('fraseChart');
            if (!ctx) return;
            
            // Destruir gr√°fico existente si hay uno
            if (window.fraseChart && typeof window.fraseChart.destroy === 'function') {
                try {
                    window.fraseChart.destroy();
                } catch (e) {
                    console.warn('Error al destruir gr√°fico anterior:', e);
                }
            }
            
            // Datos para el gr√°fico
            const chartData = {
                labels: ['Esta Frase', 'Otras Frases'],
                datasets: [{
                    label: 'Apariciones',
                    data: [datos.total, {{ total_apariciones }} - datos.total],
                    backgroundColor: ['#007bff', '#e9ecef'],
                    borderColor: ['#0056b3', '#adb5bd'],
                    borderWidth: 2
                }]
            };
            
            try {
                window.fraseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: `Distribuci√≥n de "${frase}"`
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Error al crear gr√°fico:', e);
                // Mostrar mensaje de error en lugar del gr√°fico
                ctx.innerHTML = '<div class="alert alert-warning">No se pudo crear el gr√°fico</div>';
            }
        }

        // Funci√≥n para comparar frases
        function compararFrase(frase) {
            if (!rankingGlobalData || !rankingGlobalData[frase]) {
                mostrarNotificacion('No hay datos disponibles para esta frase', 'warning');
                return;
            }

            fraseComparacion = frase;
            const datos = rankingGlobalData[frase];
            
            // Obtener top 5 frases para comparar
            const frasesComparables = Object.entries(rankingGlobalData)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 5)
                .filter(([f, _]) => f !== frase);
            
            const modalBody = document.getElementById('comparacionModalBody');
            modalBody.innerHTML = `
                <h6 class="text-success mb-3">Comparando: <strong>${frase}</strong></h6>
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">${frase}</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Apariciones:</span>
                                <span class="badge bg-primary">${datos.total}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Porcentaje:</span>
                                <span>${((datos.total / {{ total_apariciones }}) * 100).toFixed(1)}%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Posici√≥n:</span>
                                <span>${obtenerPosicionRanking(frase)}</span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-info">Otras Frases Principales</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr><th>Frase</th><th>Apariciones</th><th>%</th></tr>
                                </thead>
                                <tbody>
                                    ${frasesComparables.map(([f, d]) => `
                                        <tr>
                                            <td>${f}</td>
                                            <td><span class="badge bg-secondary">${d.total}</span></td>
                                            <td>${((d.total / {{ total_apariciones }}) * 100).toFixed(1)}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="chart-container">
                            <canvas id="comparacionChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('comparacionModal'));
            modal.show();
            
            // Crear gr√°fico de comparaci√≥n
            setTimeout(() => crearGraficoComparacion(frase, frasesComparables), 100);
        }

        // Funci√≥n para crear gr√°fico de comparaci√≥n
        function crearGraficoComparacion(frase, frasesComparables) {
            const ctx = document.getElementById('comparacionChart');
            if (!ctx) return;
            
            // Destruir gr√°fico existente si hay uno
            if (window.comparacionChart) {
                window.comparacionChart.destroy();
            }
            
            const datos = rankingGlobalData[frase];
            const chartData = {
                labels: [frase, ...frasesComparables.map(([f, _]) => f)],
                datasets: [{
                    label: 'Apariciones',
                    data: [datos.total, ...frasesComparables.map(([_, d]) => d.total)],
                    backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'],
                    borderWidth: 2
                }]
            };
            
            window.comparacionChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Comparaci√≥n de Apariciones'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Funci√≥n para resaltar frase en el ranking
        function resaltarFrase(frase) {
            // Remover resaltado previo
            document.querySelectorAll('.ranking-row').forEach(row => {
                row.classList.remove('table-warning');
            });
            
            // Resaltar la fila seleccionada
            const fila = document.querySelector(`[data-frase="${frase}"]`);
            if (fila) {
                fila.classList.add('table-warning');
                fila.scrollIntoView({ behavior: 'smooth', block: 'center' });
                mostrarNotificacion(`Frase "${frase}" resaltada en el ranking`, 'info');
            }
        }

        // Funci√≥n para obtener posici√≥n en el ranking
        function obtenerPosicionRanking(frase) {
            if (!rankingGlobalData) return 'N/A';
            
            const frases = Object.entries(rankingGlobalData)
                .sort((a, b) => b[1].total - a[1].total);
            
            const posicion = frases.findIndex(([f, _]) => f === frase);
            return posicion !== -1 ? posicion + 1 : 'N/A';
        }

        // Funci√≥n para aplicar filtros
        function aplicarFiltros() {
            const searchTerm = document.getElementById('searchFrase').value.toLowerCase();
            const minApariciones = parseInt(document.getElementById('minApariciones').value) || 1;
            const orden = document.getElementById('ordenRanking').value;
            
            const filas = document.querySelectorAll('.ranking-row');
            let filasVisibles = 0;
            
            filas.forEach(fila => {
                const frase = fila.getAttribute('data-frase').toLowerCase();
                const total = parseInt(fila.getAttribute('data-total'));
                
                const cumpleBusqueda = frase.includes(searchTerm);
                const cumpleMinimo = total >= minApariciones;
                
                if (cumpleBusqueda && cumpleMinimo) {
                    fila.style.display = '';
                    filasVisibles++;
                } else {
                    fila.style.display = 'none';
                }
            });
            
            // Reordenar filas seg√∫n el criterio seleccionado
            reordenarRanking(orden);
            
            mostrarNotificacion(`Mostrando ${filasVisibles} frases que cumplen los filtros`, 'success');
        }

        // Funci√≥n para reordenar ranking
        function reordenarRanking(orden) {
            const tbody = document.querySelector('#rankingTable tbody');
            const filas = Array.from(tbody.querySelectorAll('.ranking-row'));
            
            filas.sort((a, b) => {
                const fraseA = a.getAttribute('data-frase');
                const fraseB = b.getAttribute('data-frase');
                const totalA = parseInt(a.getAttribute('data-total'));
                const totalB = parseInt(b.getAttribute('data-total'));
                
                switch (orden) {
                    case 'total':
                        return totalB - totalA;
                    case 'porcentaje':
                        const porcentajeA = (totalA / {{ total_apariciones }}) * 100;
                        const porcentajeB = (totalB / {{ total_apariciones }}) * 100;
                        return porcentajeB - porcentajeA;
                    case 'alfabetico':
                        return fraseA.localeCompare(fraseB);
                    default:
                        return 0;
                }
            });
            
            // Reinsertar filas en el nuevo orden
            filas.forEach((fila, index) => {
                const numero = fila.querySelector('td:first-child');
                numero.textContent = index + 1;
                tbody.appendChild(fila);
            });
        }

        // Funci√≥n para mostrar gr√°fico del ranking
        function mostrarGraficoRanking() {
            if (!rankingGlobalData) {
                mostrarNotificacion('No hay datos disponibles para el gr√°fico', 'warning');
                return;
            }
            
            // Crear modal para el gr√°fico
            const modalHTML = `
                <div class="modal fade" id="graficoModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-graph-up me-2"></i>Gr√°fico del Ranking
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="chart-container">
                                    <canvas id="rankingChart"></canvas>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Agregar modal al DOM si no existe
            if (!document.getElementById('graficoModal')) {
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('graficoModal'));
            modal.show();
            
            // Crear gr√°fico
            setTimeout(() => crearGraficoRanking(), 100);
        }

        // Funci√≥n para crear gr√°fico del ranking
        function crearGraficoRanking() {
            const ctx = document.getElementById('rankingChart');
            if (!ctx) return;
            
            // Destruir gr√°fico existente si hay uno
            if (window.rankingChart) {
                window.rankingChart.destroy();
            }
            
            // Obtener top 10 frases
            const topFrases = Object.entries(rankingGlobalData)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 10);
            
            const chartData = {
                labels: topFrases.map(([f, _]) => f.length > 20 ? f.substring(0, 20) + '...' : f),
                datasets: [{
                    label: 'Apariciones',
                    data: topFrases.map(([_, d]) => d.total),
                    backgroundColor: 'rgba(0, 123, 255, 0.8)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 2
                }]
            };
            
            window.rankingChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Top 10 Frases Clave por Apariciones'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Funci√≥n para exportar ranking
        function exportarRanking() {
            if (!rankingGlobalData) {
                mostrarNotificacion('No hay datos disponibles para exportar', 'warning');
                return;
            }
            
            const frases = Object.entries(rankingGlobalData)
                .sort((a, b) => b[1].total - a[1].total)
                .map(([frase, datos], index) => ({
                    posicion: index + 1,
                    frase: frase,
                    apariciones: datos.total,
                    porcentaje: ((datos.total / {{ total_apariciones }}) * 100).toFixed(1)
                }));
            
            const csv = [
                ['Posici√≥n', 'Frase Clave', 'Apariciones', 'Porcentaje'],
                ...frases.map(f => [f.posicion, f.frase, f.apariciones, f.porcentaje + '%'])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ranking_frases_clave.csv';
            link.click();
            
            mostrarNotificacion('Ranking exportado como CSV', 'success');
        }

        // Funci√≥n para exportar detalles de frase
        function exportarFraseDetalle() {
            if (!fraseSeleccionada || !rankingGlobalData[fraseSeleccionada]) {
                mostrarNotificacion('No hay frase seleccionada para exportar', 'warning');
                return;
            }
            
            const datos = rankingGlobalData[fraseSeleccionada];
            const contenido = `Detalles de Frase Clave: ${fraseSeleccionada}\n\n` +
                            `Total Apariciones: ${datos.total}\n` +
                            `Porcentaje: ${((datos.total / {{ total_apariciones }}) * 100).toFixed(1)}%\n` +
                            `Posici√≥n en Ranking: ${obtenerPosicionRanking(fraseSeleccionada)}\n\n` +
                            `Ocurrencias:\n${JSON.stringify(datos.ocurrencias || [], null, 2)}`;
            
            const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `detalle_${fraseSeleccionada.replace(/[^a-zA-Z0-9]/g, '_')}.txt`;
            link.click();
            
            mostrarNotificacion('Detalles de frase exportados', 'success');
        }

        // ===== FUNCIONES PARA DOCUMENTOS =====

        // Funci√≥n para mostrar detalles de un documento espec√≠fico
        function mostrarDetallesDocumento(nombreArchivo) {
            // Obtener datos del documento desde el backend
            fetch(`/api/documento/${encodeURIComponent(nombreArchivo)}`)
                .then(response => response.json())
                .then(data => {
                    const modalBody = document.getElementById('documentoModalBody');
                    const modalTitle = document.getElementById('documentoModalLabel');
                    
                    modalTitle.innerHTML = `<i class="bi bi-file-text me-2"></i>${nombreArchivo}`;
                    
                    if (data.error) {
                        modalBody.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Error al obtener detalles: ${data.error}
                            </div>
                        `;
                    } else {
                        modalBody.innerHTML = generarContenidoDocumento(nombreArchivo, data);
                    }
                    
                    // Mostrar modal
                    const modal = new bootstrap.Modal(document.getElementById('documentoModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error obteniendo detalles del documento:', error);
                    mostrarNotificacion('Error obteniendo detalles del documento', 'danger');
                });
        }

        // Funci√≥n para generar contenido del modal de documento
        function generarContenidoDocumento(nombreArchivo, datos) {
            let contenido = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Informaci√≥n del Documento</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Nombre:</strong></td><td>${nombreArchivo}</td></tr>
                            <tr><td><strong>Estado:</strong></td><td>
                                ${datos.procesado ? 
                                    '<span class="badge bg-success">Procesado</span>' : 
                                    '<span class="badge bg-danger">Error</span>'
                                }
                            </td></tr>
                            <tr><td><strong>Tipo:</strong></td><td>${nombreArchivo.split('.').pop().toUpperCase()}</td></tr>
                            <tr><td><strong>Tama√±o:</strong></td><td>${datos.tama√±o || 'N/A'}</td></tr>
                            <tr><td><strong>Fecha Procesamiento:</strong></td><td>${datos.fecha_procesamiento || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-success">Estad√≠sticas de An√°lisis</h6>
                        <div class="row">
                            <div class="col-6">
                                <div class="card bg-light text-center p-3">
                                    <h4 class="text-primary mb-1">${datos.frases_clave ? Object.keys(datos.frases_clave).length : 0}</h4>
                                    <small class="text-muted">Categor√≠as</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light text-center p-3">
                                    <h4 class="text-success mb-1">${datos.total_frases || 0}</h4>
                                    <small class="text-muted">Frases Clave</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (datos.frases_clave && Object.keys(datos.frases_clave).length > 0) {
                contenido += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-info">Frases Clave Encontradas</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Categor√≠a</th>
                                            <th>Frases</th>
                                            <th>Apariciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                Object.entries(datos.frases_clave).forEach(([categoria, info]) => {
                    contenido += `
                        <tr>
                            <td><strong>${categoria.replace(/_/g, ' ').toUpperCase()}</strong></td>
                            <td>${info.frases ? info.frases.join(', ') : 'N/A'}</td>
                            <td><span class="badge bg-primary">${info.total}</span></td>
                        </tr>
                    `;
                });
                
                contenido += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (datos.error) {
                contenido += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-danger">
                                <h6 class="text-danger">Error en Procesamiento</h6>
                                <p class="mb-0">${datos.error}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            return contenido;
        }

        // Funci√≥n para mostrar detalles generales de todos los documentos
        function mostrarDetallesDocumentos() {
            const modalBody = document.getElementById('documentosGeneralesModalBody');
            
            // Obtener datos de los documentos desde el DOM
            const documentos = {{ resultados_por_archivo|tojson|safe }};
            
            if (!documentos || Object.keys(documentos).length === 0) {
                modalBody.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No hay documentos disponibles para mostrar.
                    </div>
                `;
            } else {
                let contenido = `
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="text-primary">Resumen de Documentos</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white text-center p-3">
                                        <h4 class="mb-1">${Object.keys(documentos).length}</h4>
                                        <small>Total Documentos</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white text-center p-3">
                                        <h4 class="mb-1">${Object.values(documentos).filter(d => d.procesado).length}</h4>
                                        <small>Procesados</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white text-center p-3">
                                        <h4 class="mb-1">${Object.values(documentos).filter(d => !d.procesado).length}</h4>
                                        <small>Con Errores</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white text-center p-3">
                                        <h4 class="mb-1">${Object.values(documentos).reduce((sum, d) => sum + (d.total_frases || 0), 0)}</h4>
                                        <small>Total Frases</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-success">Lista Detallada</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Documento</th>
                                            <th>Estado</th>
                                            <th>Categor√≠as</th>
                                            <th>Frases</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                Object.entries(documentos).forEach(([nombre, datos]) => {
                    contenido += `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    ${nombre.endsWith('.pdf') ? '<i class="bi bi-file-pdf text-danger me-2"></i>' : 
                                      nombre.endsWith('.txt') ? '<i class="bi bi-file-text text-primary me-2"></i>' : 
                                      '<i class="bi bi-file-earmark text-secondary me-2"></i>'}
                                    <span title="${nombre}">${nombre.length > 30 ? nombre.substring(0, 30) + '...' : nombre}</span>
                                </div>
                            </td>
                            <td>
                                ${datos.procesado ? 
                                    '<span class="badge bg-success">Procesado</span>' : 
                                    '<span class="badge bg-danger">Error</span>'
                                }
                            </td>
                            <td>
                                <span class="badge bg-info">${datos.frases_clave ? Object.keys(datos.frases_clave).length : 0}</span>
                            </td>
                            <td>
                                <span class="badge bg-secondary">${datos.total_frases || 0}</span>
                            </td>
                            <td>
                                <button class="btn btn-outline-primary btn-sm" onclick="mostrarDetallesDocumento('${nombre}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                contenido += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                modalBody.innerHTML = contenido;
            }
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('documentosGeneralesModal'));
            modal.show();
        }

        // Funci√≥n para ver el documento (descargar o abrir)
        function verDocumento(nombreArchivo) {
            // Intentar abrir el documento en una nueva pesta√±a
            const url = `/documento/${encodeURIComponent(nombreArchivo)}`;
            window.open(url, '_blank');
        }

        // Funci√≥n para exportar lista de documentos
        function exportarDocumentos() {
            const documentos = {{ resultados_por_archivo|tojson|safe }};
            
            if (!documentos || Object.keys(documentos).length === 0) {
                mostrarNotificacion('No hay documentos para exportar', 'warning');
                return;
            }
            
            const csv = [
                ['Documento', 'Estado', 'Categor√≠as', 'Total Frases', 'Error'],
                ...Object.entries(documentos).map(([nombre, datos]) => [
                    nombre,
                    datos.procesado ? 'Procesado' : 'Error',
                    datos.frases_clave ? Object.keys(datos.frases_clave).length : 0,
                    datos.total_frases || 0,
                    datos.error || 'N/A'
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'documentos_analizados.csv';
            link.click();
            
            mostrarNotificacion('Lista de documentos exportada', 'success');
        }

        // Funci√≥n para exportar detalles de documento
        function exportarDocumentoDetalle() {
            // Esta funci√≥n se implementar√° cuando se seleccione un documento
            mostrarNotificacion('Funci√≥n de exportaci√≥n de documento en desarrollo', 'info');
        }

        // Funci√≥n para exportar resumen de documentos
        function exportarResumenDocumentos() {
            const documentos = {{ resultados_por_archivo|tojson|safe }};
            
            if (!documentos || Object.keys(documentos).length === 0) {
                mostrarNotificacion('No hay documentos para exportar', 'warning');
                return;
            }
            
            const resumen = `RESUMEN DE DOCUMENTOS ANALIZADOS\n` +
                           `================================\n\n` +
                           `Total de Documentos: ${Object.keys(documentos).length}\n` +
                           `Documentos Procesados: ${Object.values(documentos).filter(d => d.procesado).length}\n` +
                           `Documentos con Errores: ${Object.values(documentos).filter(d => !d.procesado).length}\n` +
                           `Total de Frases Clave: ${Object.values(documentos).reduce((sum, d) => sum + (d.total_frases || 0), 0)}\n\n` +
                           `DETALLES POR DOCUMENTO:\n` +
                           `======================\n\n` +
                           Object.entries(documentos).map(([nombre, datos]) => 
                               `${nombre}:\n` +
                               `  Estado: ${datos.procesado ? 'Procesado' : 'Error'}\n` +
                               `  Categor√≠as: ${datos.frases_clave ? Object.keys(datos.frases_clave).length : 0}\n` +
                               `  Frases: ${datos.total_frases || 0}\n` +
                               `  ${datos.error ? `Error: ${datos.error}` : ''}\n`
                           ).join('\n');
            
            const blob = new Blob([resumen], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'resumen_documentos.txt';
            link.click();
            
            mostrarNotificacion('Resumen de documentos exportado', 'success');
        }

        // Funci√≥n para debug de datos de frases
        function debugFraseData() {
            console.log('=== DEBUG: Datos de frases ===');
            
            if (!rankingGlobalData) {
                console.error('‚ùå No hay datos del ranking disponibles');
                return;
            }
            
            console.log('üìä Datos del ranking:', rankingGlobalData);
            console.log(`üîë Total de categor√≠as: ${Object.keys(rankingGlobalData).length}`);
            
            const elementos = document.querySelectorAll('[data-frase]');
            console.log(`üìã Elementos encontrados: ${elementos.length}`);
            
            elementos.forEach((elemento, index) => {
                const frase = elemento.getAttribute('data-frase');
                const fraseIndex = elemento.getAttribute('data-frase-index');
                
                console.log(`Elemento ${index + 1}:`);
                console.log(`  Frase: ${frase}`);
                console.log(`  √çndice: ${fraseIndex}`);
                
                if (rankingGlobalData && rankingGlobalData[frase]) {
                    const datos = rankingGlobalData[frase];
                    console.log(`  ‚úÖ Datos disponibles:`, datos);
                    console.log(`  üìä Total: ${datos.total}`);
                    console.log(`  üìÑ Ocurrencias: ${datos.ocurrencias ? datos.ocurrencias.length : 0}`);
                } else {
                    console.error(`  ‚ùå No hay datos para la frase: ${frase}`);
                }
                console.log('---');
            });
        }

        // Funci√≥n para probar b√∫squeda de argumentos
        function testBusquedaArgumentos() {
            console.log('=== TEST: B√∫squeda de Argumentos ===');
            mostrarNotificacion('Test de b√∫squeda ejecutado', 'info');
        }

        // Funci√≥n para verificar backend
        async function verificarDatosBackend() {
            try {
                const response = await fetch('/api/analizar');
                const data = await response.json();
                console.log('‚úÖ Backend responde:', data);
                mostrarNotificacion('Backend verificado correctamente', 'success');
            } catch (error) {
                console.error('‚ùå Error backend:', error);
                mostrarNotificacion('Error verificando backend', 'danger');
            }
        }

        // Funci√≥n para an√°lisis inteligente
        async function mostrarAnalisisInteligente() {
            try {
                const response = await fetch('/api/analizar');
                const datos = await response.json();
                console.log('‚úÖ An√°lisis inteligente:', datos);
                mostrarNotificacion('An√°lisis inteligente ejecutado', 'success');
            } catch (error) {
                console.error('‚ùå Error an√°lisis:', error);
                mostrarNotificacion('Error en an√°lisis inteligente', 'danger');
            }
        }

        // Funci√≥n para debug avanzado
        async function debugAvanzado() {
            console.log('üö® === DEBUG AVANZADO ===');
            mostrarNotificacion('Debug avanzado ejecutado', 'info');
        }

        // Funci√≥n de prueba
        function testShowFraseDetails() {
            console.log('=== TEST: showFraseDetails ===');
            mostrarNotificacion('Test ejecutado correctamente', 'success');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM cargado, inicializando aplicaci√≥n...');
            
            // Cargar datos del ranking
            if (cargarDatosRanking()) {
                console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
            } else {
                console.error('‚ùå Error inicializando la aplicaci√≥n');
            }
            
            // Configurar event listeners para filtros
            document.getElementById('searchFrase').addEventListener('input', function() {
                if (this.value.length >= 2 || this.value.length === 0) {
                    aplicarFiltros();
                }
            });
            
            document.getElementById('minApariciones').addEventListener('change', aplicarFiltros);
            document.getElementById('ordenRanking').addEventListener('change', aplicarFiltros);
        });
    </script>
</body>
</html>
