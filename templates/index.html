<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Resoluciones IPP/INSS</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Estilos personalizados -->
    <link href="/static/style.css" rel="stylesheet">
    
    <style>
        .clickable-frase {
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .clickable-frase:hover {
            background-color: #e3f2fd;
            color: #1976d2;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .ranking-filters {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .frase-highlight {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 2px 6px;
            margin: 2px;
            display: inline-block;
        }
        
        .stats-card {
            transition: transform 0.2s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
        }
        
        .modal-xl {
            max-width: 90%;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .documento-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }
        
        .documento-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #007bff;
        }
        
        .documento-card .card-body {
            min-height: 120px;
        }
        
        .documento-card .card-title {
            font-size: 0.9rem;
            line-height: 1.2;
        }
        
        .text-truncate {
            max-width: 200px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-file-text me-2"></i>
                Analizador de Resoluciones IPP/INSS
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/subir">
                    <i class="bi bi-upload me-1"></i>Subir Documento
                </a>
                <a class="nav-link" href="#" onclick="abrirGestorFrases()">
                    <i class="bi bi-sliders me-1"></i>Frases Clave
                </a>
                <a class="nav-link" href="/diagnostico">
                    <i class="bi bi-activity me-1"></i>Diagnóstico
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Título -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-5 text-center text-primary mb-3">
                    <i class="bi bi-search me-3"></i>Análisis de Resoluciones Administrativas
                </h1>
                <p class="lead text-center text-muted">
                    Sistema de análisis automático de resoluciones en busca de frases clave
                </p>
                
                <!-- Botón para subir archivos -->
                <div class="text-center mt-4">
                    <a href="/subir" class="btn btn-success btn-lg">
                        <i class="bi bi-upload me-2"></i>Subir Nuevo Documento
                    </a>
                    <button class="btn btn-outline-danger btn-lg ms-2" onclick="abrirGestorDocumentos()">
                        <i class="bi bi-trash3 me-2"></i>Eliminar Documento
                    </button>
                </div>
            </div>
        </div>

        <!-- Botones de debug -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button class="btn btn-warning" onclick="testShowFraseDetails()">
                    <i class="bi bi-bug me-2"></i>Test: Ver Detalles
                </button>
                <button class="btn btn-info" onclick="debugFraseData()">
                    <i class="bi bi-info-circle me-2"></i>Debug: Datos Frases
                </button>
                <button class="btn btn-success" onclick="testBusquedaArgumentos()">
                    <i class="bi bi-search me-2"></i>Test: Búsqueda Argumentos
                </button>
                <button class="btn btn-dark" onclick="verificarDatosBackend()">
                    <i class="bi bi-server me-2"></i>Verificar Backend
                </button>
                <button class="btn btn-primary" onclick="mostrarAnalisisInteligente()">
                    <i class="bi bi-brain me-2"></i>Análisis Inteligente
                </button>
                <button class="btn btn-danger" onclick="debugAvanzado()">
                    <i class="bi bi-exclamation-triangle me-2"></i>Debug Avanzado
                </button>
                <button class="btn btn-warning" onclick="limpiarCache()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Limpiar Caché
                </button>
            </div>
        </div>

        {% if show_upload_section %}
        <!-- Sección de Subida de Documentos -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-upload me-2"></i>Subir Nuevo Documento
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="archivoInput" class="form-label">Seleccionar archivo:</label>
                                        <input type="file" class="form-control" id="archivoInput" accept=".pdf,.txt" required>
                                        <div class="form-text">Formatos soportados: PDF, TXT (máximo 10MB)</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="submit" class="btn btn-success w-100" id="btnSubir">
                                            <i class="bi bi-upload me-2"></i>Subir Documento
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        
                        <div id="uploadProgress" class="mt-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted mt-1 d-block">Subiendo archivo...</small>
                        </div>
                        
                        <div id="uploadResult" class="mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Documentos Analizados -->
        {% if resultados_por_archivo %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-files me-2"></i>Documentos Analizados
                            <span class="badge bg-light text-dark ms-2">{{ resultados_por_archivo|length }} documentos</span>
                        </h5>
                        <div>
                            <button class="btn btn-light btn-sm" onclick="exportarDocumentos()">
                                <i class="bi bi-download me-1"></i>Exportar Lista
                            </button>
                            <button class="btn btn-light btn-sm" onclick="mostrarDetallesDocumentos()">
                                <i class="bi bi-info-circle me-1"></i>Ver Detalles
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for nombre_archivo, resultado in resultados_por_archivo.items() %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100 border-0 shadow-sm documento-card" 
                                     data-archivo="{{ nombre_archivo }}"
                                     onclick="mostrarDetallesDocumento('{{ nombre_archivo }}')">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center mb-2">
                                            {% if nombre_archivo.endswith('.pdf') %}
                                                <i class="bi bi-file-pdf text-danger fs-4 me-2"></i>
                                            {% elif nombre_archivo.endswith('.txt') %}
                                                <i class="bi bi-file-text text-primary fs-4 me-2"></i>
                                            {% else %}
                                                <i class="bi bi-file-earmark text-secondary fs-4 me-2"></i>
                                            {% endif %}
                                            <h6 class="card-title mb-0 text-truncate" title="{{ nombre_archivo }}">
                                                {{ nombre_archivo }}
                                                {% set n = nombre_archivo|lower %}
                                                {% if 'tribunal supremo' in n or 'ts_' in n or ' ts ' in n or 'ts-' in n %}
                                                    <span class="badge bg-warning text-dark ms-2" title="Tribunal Supremo">TS</span>
                                                {% elif 'tsj' in n or 'tribunal superior' in n %}
                                                    <span class="badge bg-warning text-dark ms-2" title="Tribunal Superior de Justicia">TSJ</span>
                                                {% endif %}
                                            </h6>
                                        </div>
                                        
                                        {% if resultado.get('procesado') %}
                                            <div class="text-success mb-2">
                                                <i class="bi bi-check-circle me-1"></i>
                                                <small>Procesado correctamente</small>
                                            </div>
                                            {% if resultado.get('frases_clave') %}
                                                <div class="mb-2">
                                                    <small class="text-muted">
                                                        <i class="bi bi-tags me-1"></i>
                                                        {{ resultado.frases_clave|length }} categorías encontradas
                                                    </small>
                                                </div>
                                                <div class="mb-2">
                                                    <small class="text-muted">
                                                        <i class="bi bi-search me-1"></i>
                                                        {{ resultado.get('total_frases', 0) }} frases clave
                                                    </small>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <div class="text-danger mb-2">
                                                <i class="bi bi-x-circle me-1"></i>
                                                <small>Error en procesamiento</small>
                                            </div>
                                            {% if resultado.get('error') %}
                                                <div class="text-danger">
                                                    <small>{{ resultado.error }}</small>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <div class="card-footer bg-transparent border-0 p-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                {% if resultado.get('procesado') %}
                                                                                                    <i class="bi bi-clock me-1"></i>
                                                {{ resultado.get('timestamp', 'N/A') }}
                                                {% endif %}
                                            </small>
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    onclick="event.stopPropagation(); verDocumento('{{ nombre_archivo }}')"
                                                    title="Ver documento">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-warning btn-sm" 
                                                    onclick="event.stopPropagation(); generarDemandaDesde('{{ nombre_archivo }}')"
                                                    title="Demanda base desde este documento">
                                                <i class="bi bi-file-earmark-text"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" 
                                                    onclick="event.stopPropagation(); analizarDiscrepancias('{{ nombre_archivo }}')"
                                                    title="Análisis de discrepancias médicas-legales">
                                                <i class="bi bi-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Ranking Global -->
        {% if ranking_global %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-trophy me-2"></i>Ranking Global de Frases Clave
                        </h5>
                        <div>
                            <button class="btn btn-light btn-sm" onclick="exportarRanking()">
                                <i class="bi bi-download me-1"></i>Exportar
                            </button>
                            <button class="btn btn-light btn-sm" onclick="mostrarGraficoRanking()">
                                <i class="bi bi-graph-up me-1"></i>Gráfico
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros y búsqueda -->
                    <div class="ranking-filters">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="searchFrase" class="form-label">Buscar frase:</label>
                                <input type="text" class="form-control" id="searchFrase" placeholder="Escriba para filtrar...">
                            </div>
                            <div class="col-md-3">
                                <label for="minApariciones" class="form-label">Mín. apariciones:</label>
                                <input type="number" class="form-control" id="minApariciones" min="1" value="1">
                            </div>
                            <div class="col-md-3">
                                <label for="ordenRanking" class="form-label">Ordenar por:</label>
                                <select class="form-select" id="ordenRanking">
                                    <option value="total">Total apariciones</option>
                                    <option value="porcentaje">Porcentaje</option>
                                    <option value="alfabetico">Alfabético</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="aplicarFiltros()">
                                    <i class="bi bi-funnel me-1"></i>Filtrar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="rankingTable">
                                <thead>
                                    <tr>
                                        <th class="px-4">#</th>
                                        <th>Frase Clave</th>
                                        <th class="text-center">Apariciones</th>
                                        <th class="text-center">Porcentaje</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for frase, datos in ranking_global.items() %}
                                    <tr class="ranking-row" data-frase="{{ frase }}" data-total="{{ datos.total }}">
                                        <td class="px-4 fw-bold text-primary">{{ loop.index }}</td>
                                        <td>
                                            <span class="clickable-frase" 
                                                  data-frase="{{ frase }}" 
                                                  data-frase-index="{{ loop.index0 }}"
                                                  onclick="mostrarDetallesFrase('{{ frase }}')">
                                                {{ frase }}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-primary fs-6">{{ datos.total }}</span>
                                        </td>
                                        <td class="text-center">
                                            {{ (datos.total / total_apariciones * 100) | round(1) }}%
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-info" onclick="mostrarDetallesFrase('{{ frase }}')" title="Ver detalles">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-success" onclick="compararFrase('{{ frase }}')" title="Comparar">
                                                    <i class="bi bi-arrow-left-right"></i>
                                                </button>
                                                <button class="btn btn-outline-warning" onclick="resaltarFrase('{{ frase }}')" title="Resaltar">
                                                    <i class="bi bi-highlighter"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Estadísticas rápidas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card border-0 shadow-sm text-center">
                    <div class="card-body">
                        <i class="bi bi-list-ol text-primary fs-1"></i>
                        <h5 class="card-title mt-2">{{ ranking_global|length }}</h5>
                        <p class="card-text text-muted">Frases Clave</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card border-0 shadow-sm text-center">
                    <div class="card-body">
                        <i class="bi bi-file-text text-success fs-1"></i>
                        <h5 class="card-title mt-2">{{ total_apariciones }}</h5>
                        <p class="card-text text-muted">Total Apariciones</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card border-0 shadow-sm text-center">
                    <div class="card-body">
                        <i class="bi bi-graph-up text-warning fs-1"></i>
                        <h5 class="card-title mt-2">{{ (ranking_global.values() | map(attribute='total') | max) if ranking_global else 0 }}</h5>
                        <p class="card-text text-muted">Máx. Apariciones</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card border-0 shadow-sm text-center">
                    <div class="card-body">
                        <i class="bi bi-percent text-info fs-1"></i>
                        <h5 class="card-title mt-2">{{ ((ranking_global.values() | map(attribute='total') | max) / total_apariciones * 100) | round(1) if ranking_global and total_apariciones > 0 else 0 }}%</h5>
                        <p class="card-text text-muted">Frase Dominante</p>
                    </div>
                </div>
            </div>
        </div>
        
        {% if show_predictive_analysis %}
        <!-- Sección de Análisis Predictivo -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-crystal-ball me-2"></i>Análisis Predictivo Inteligente
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Predicciones Basadas en Datos</h5>
                                <div class="prediction-card">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span><strong>Probabilidad de Éxito:</strong></span>
                                        <span class="badge bg-success">75%</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span><strong>Tipo de Resolución:</strong></span>
                                        <span class="badge bg-info">Favorable Parcial</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span><strong>Factor Clave:</strong></span>
                                        <span class="text-primary">Incapacidad Permanente</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>Patrones Detectados</h5>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Documentos con "incapacidad":</span>
                                        <span class="badge bg-primary">{{ total_apariciones }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Resoluciones favorables:</span>
                                        <span class="badge bg-success">60%</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Tiempo promedio:</span>
                                        <span class="badge bg-warning">3-6 meses</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h5>Recomendaciones Inteligentes</h5>
                                <div class="alert alert-info">
                                    <i class="bi bi-lightbulb me-2"></i>
                                    <strong>Basado en el análisis de {{ archivos_analizados }} documentos:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>Enfócate en documentar las <strong>lesiones permanentes</strong> del hombro</li>
                                        <li>Destaca la <strong>incapacidad permanente parcial</strong> en tu solicitud</li>
                                        <li>Incluye referencias a <strong>prestaciones económicas</strong> correspondientes</li>
                                        <li>Presenta <strong>fundamentos jurídicos</strong> sólidos</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Botón de Análisis Predictivo -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <a href="/analisis-predictivo" class="btn btn-primary btn-lg">
                    <i class="bi bi-crystal-ball me-2"></i>Análisis Predictivo Inteligente
                </a>
                <p class="text-muted mt-2">
                    Descubre patrones ocultos y predice resultados basándote en el análisis inteligente
                </p>
            </div>
        </div>
        {% endif %}
        {% endif %}
    </div>

    <!-- Modal para detalles de frase -->
    <div class="modal fade" id="fraseModal" tabindex="-1" aria-labelledby="fraseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="fraseModalLabel">
                        <i class="bi bi-info-circle me-2"></i>Detalles de Frase Clave
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="fraseModalBody">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="exportarFraseDetalle()">Exportar Detalles</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gestor de Frases Clave (CRUD) -->
    <div class="modal fade" id="gestorFrasesModal" tabindex="-1" aria-labelledby="gestorFrasesLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="gestorFrasesLabel">
                        <i class="bi bi-sliders me-2"></i>Gestor de Frases Clave
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    Categorías
                                </div>
                                <div class="card-body">
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-8">
                                            <input id="buscarCategoriaInput" type="text" class="form-control" placeholder="Buscar categoría...">
                                        </div>
                                        <div class="col-md-4">
                                            <div class="input-group">
                                                <label class="input-group-text" for="catsPerPage">Por pág.</label>
                                                <select id="catsPerPage" class="form-select">
                                                    <option value="10">10</option>
                                                    <option value="20" selected>20</option>
                                                    <option value="50">50</option>
                                                    <option value="100">100</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="input-group mb-2">
                                        <input id="nuevaCategoriaInput" type="text" class="form-control" placeholder="Nueva categoría (ej. penal)">
                                        <button class="btn btn-primary" onclick="crearCategoria()">Añadir</button>
                                    </div>
                                    <ul id="listaCategorias" class="list-group" style="max-height: 400px; overflow:auto"></ul>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <div id="catsInfo" class="text-muted small"></div>
                                        <div class="btn-group btn-group-sm" role="group" aria-label="Paginación categorías">
                                            <button class="btn btn-outline-secondary" onclick="cambiarPaginaCategorias(-1)">Anterior</button>
                                            <span id="catsPaginaActual" class="btn btn-outline-secondary disabled">1/1</span>
                                            <button class="btn btn-outline-secondary" onclick="cambiarPaginaCategorias(1)">Siguiente</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span id="tituloCategoria">Frases de: <em>—</em></span>
                                    <button id="btnEliminarCategoria" class="btn btn-sm btn-outline-danger" onclick="eliminarCategoriaActual()" disabled>
                                        <i class="bi bi-trash"></i> Eliminar categoría
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-2">
                                        <input id="nuevaFraseInput" type="text" class="form-control" placeholder="Nueva frase...">
                                        <button class="btn btn-success" onclick="agregarFrase()">Añadir frase</button>
                                    </div>
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-8">
                                            <input id="buscarFraseInput" type="text" class="form-control" placeholder="Buscar frase en la categoría...">
                                        </div>
                                        <div class="col-md-4">
                                            <div class="input-group">
                                                <label class="input-group-text" for="frasesPerPage">Por pág.</label>
                                                <select id="frasesPerPage" class="form-select">
                                                    <option value="10">10</option>
                                                    <option value="20" selected>20</option>
                                                    <option value="50">50</option>
                                                    <option value="100">100</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="listaFrases" class="mt-2" style="max-height: 400px; overflow:auto"></div>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <div id="frasesInfo" class="text-muted small"></div>
                                        <div class="btn-group btn-group-sm" role="group" aria-label="Paginación frases">
                                            <button class="btn btn-outline-secondary" onclick="cambiarPaginaFrases(-1)">Anterior</button>
                                            <span id="frasesPaginaActual" class="btn btn-outline-secondary disabled">1/1</span>
                                            <button class="btn btn-outline-secondary" onclick="cambiarPaginaFrases(1)">Siguiente</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="reanalizarAnalisis()">Reanalizar ahora</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para comparación -->
    <div class="modal fade" id="comparacionModal" tabindex="-1" aria-labelledby="comparacionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="comparacionModalLabel">
                        <i class="bi bi-arrow-left-right me-2"></i>Comparación de Frases
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="comparacionModalBody">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles de documento -->
    <div class="modal fade" id="documentoModal" tabindex="-1" aria-labelledby="documentoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="documentoModalLabel">
                        <i class="bi bi-file-text me-2"></i>Detalles del Documento
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="documentoModalBody">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="exportarDocumentoDetalle()">Exportar Detalles</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles generales de documentos -->
    <div class="modal fade" id="documentosGeneralesModal" tabindex="-1" aria-labelledby="documentosGeneralesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="documentosGeneralesModalLabel">
                        <i class="bi bi-files me-2"></i>Resumen General de Documentos
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="documentosGeneralesModalBody">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" onclick="exportarResumenDocumentos()">Exportar Resumen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gestor de Documentos (Eliminar) -->
    <div class="modal fade" id="gestorDocumentosModal" tabindex="-1" aria-labelledby="gestorDocumentosLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="gestorDocumentosLabel">
                        <i class="bi bi-trash3 me-2"></i>Eliminar Documentos
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="input-group" style="max-width: 420px;">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input id="buscarDocumentoInput" type="text" class="form-control" placeholder="Buscar por nombre...">
                        </div>
                        <div id="docsResumen" class="text-muted small"></div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th style="width:40%">Nombre</th>
                                    <th style="width:15%">Carpeta</th>
                                    <th style="width:15%">Tamaño</th>
                                    <th style="width:20%">Modificado</th>
                                    <th class="text-end" style="width:10%">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaDocumentosBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script con datos del backend -->
    <script type="application/json" id="rankingData">
        {{ ranking_global|tojson|safe }}
    </script>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Variables globales definidas fuera del bloque JavaScript -->
    <script>
        // eslint-disable-next-line
        window.totalApariciones = {{ total_apariciones|default(1) | tojson }};
        // eslint-disable-next-line
        window.documentosData = {{ resultados_por_archivo|tojson|safe }};
    </script>
    
    <!-- Script personalizado -->
    <script>
        // Variables globales
        let rankingGlobalData = null;
        let fraseSeleccionada = null;
        let fraseComparacion = null;
        let categoriasFrases = {};
        let categoriaSeleccionada = null;
        // Estado para búsqueda y paginación de frases
        let fraseQuery = '';
        let frasePage = 1;
        let frasesPerPage = 20;
        
        // Estado para búsqueda y paginación de categorías
        let catQuery = '';
        let catPage = 1;
        let catsPerPage = 20;

        // Función para mostrar notificaciones
        function mostrarNotificacion(mensaje, tipo) {
            const notificacion = document.createElement('div');
            notificacion.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
            notificacion.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notificacion.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.remove();
                }
            }, 5000);
        }

        // ====== GESTOR DE FRASES CLAVE (CRUD) ======
        function abrirGestorFrases() {
            cargarCategorias().then(() => {
                // Asegurar categoría seleccionada por defecto
                if (!categoriaSeleccionada) {
                    const claves = Object.keys(categoriasFrases || {});
                    if (claves.length > 0) {
                        seleccionarCategoria(claves[0]);
                    }
                }
                const modal = new bootstrap.Modal(document.getElementById('gestorFrasesModal'));
                modal.show();
            });
        }

        async function cargarCategorias() {
            try {
                const res = await fetch('/api/frases');
                const data = await res.json();
                categoriasFrases = data.categorias || {};
                renderCategorias();
            } catch (e) {
                mostrarNotificacion('No se pudieron cargar las frases clave', 'danger');
            }
        }

        function renderCategorias() {
            const ul = document.getElementById('listaCategorias');
            ul.innerHTML = '';
            const todas = Object.keys(categoriasFrases).sort();
            const filtradas = catQuery ? todas.filter(c => c.toLowerCase().includes(catQuery.toLowerCase())) : todas;
            const total = filtradas.length;
            const totalPages = Math.max(1, Math.ceil(total / Math.max(1, catsPerPage)));
            if (catPage > totalPages) catPage = totalPages;
            if (catPage < 1) catPage = 1;
            const start = (catPage - 1) * Math.max(1, catsPerPage);
            const end = start + Math.max(1, catsPerPage);
            const pageCats = filtradas.slice(start, end);

            pageCats.forEach(cat => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <span class="categoria-nombre" style="cursor:pointer">${cat}</span>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" title="Renombrar"
                                onclick="event.stopPropagation(); renombrarCategoria('${encodeURIComponent(cat)}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <span class="badge bg-primary rounded-pill">${categoriasFrases[cat].length}</span>
                    </div>
                `;
                li.querySelector('.categoria-nombre').onclick = () => seleccionarCategoria(cat);
                ul.appendChild(li);
            });
            if (!categoriaSeleccionada && filtradas.length) {
                seleccionarCategoria(filtradas[0]);
            } else if (categoriaSeleccionada) {
                seleccionarCategoria(categoriaSeleccionada);
            }
            const info = document.getElementById('catsInfo');
            const badge = document.getElementById('catsPaginaActual');
            if (info) info.textContent = `${total} categoría(s) • mostrando ${total ? start + 1 : 0}-${Math.min(end, total)}`;
            if (badge) badge.textContent = `${catPage}/${totalPages}`;
        }

        function seleccionarCategoria(cat) {
            categoriaSeleccionada = cat;
            document.getElementById('tituloCategoria').innerText = `Frases de: ${cat}`;
            document.getElementById('btnEliminarCategoria').disabled = false;
            // reset búsqueda/paginación al cambiar de categoría
            fraseQuery = '';
            frasePage = 1;
            const buscarInput = document.getElementById('buscarFraseInput');
            if (buscarInput) buscarInput.value = '';
            renderFrases();
        }

        function renderFrases() {
            const cont = document.getElementById('listaFrases');
            cont.innerHTML = '';
            const todas = categoriasFrases[categoriaSeleccionada] || [];
            // Filtrado por búsqueda
            const filtradas = fraseQuery
                ? todas.filter(f => (f || '').toLowerCase().includes(fraseQuery.toLowerCase()))
                : todas.slice();
            // Paginación
            const total = filtradas.length;
            const totalPages = Math.max(1, Math.ceil(total / Math.max(1, frasesPerPage)));
            if (frasePage > totalPages) frasePage = totalPages;
            if (frasePage < 1) frasePage = 1;
            const start = (frasePage - 1) * Math.max(1, frasesPerPage);
            const end = start + Math.max(1, frasesPerPage);
            const frases = filtradas.slice(start, end);

            if (total === 0) {
                cont.innerHTML = '<div class="text-muted">Sin frases en esta categoría</div>';
                document.getElementById('frasesInfo').textContent = '';
                document.getElementById('frasesPaginaActual').textContent = '0/0';
                return;
            }
            frases.forEach(frase => {
                const div = document.createElement('div');
                div.className = 'd-flex align-items-center border rounded p-2 mb-2';
                div.innerHTML = `
                    <span class="flex-grow-1">${frase}</span>
                    <button class="btn btn-sm btn-outline-secondary ms-2" title="Editar" onclick="editarFrase('${encodeURIComponent(frase)}')"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-outline-danger ms-2" title="Eliminar" onclick="eliminarFrase('${encodeURIComponent(frase)}')"><i class="bi bi-x"></i></button>
                `;
                cont.appendChild(div);
            });
            // Actualizar info y paginación
            document.getElementById('frasesInfo').textContent = `${total} frase(s) • mostrando ${start + 1}-${Math.min(end, total)}`;
            document.getElementById('frasesPaginaActual').textContent = `${frasePage}/${totalPages}`;
        }

        function cambiarPaginaFrases(delta) {
            frasePage += delta;
            if (frasePage < 1) frasePage = 1;
            renderFrases();
        }

        function cambiarPaginaCategorias(delta) {
            catPage += delta;
            if (catPage < 1) catPage = 1;
            renderCategorias();
        }

        async function crearCategoria() {
            const nombre = document.getElementById('nuevaCategoriaInput').value.trim();
            if (!nombre) return;
            try {
                const res = await fetch('/api/frases/categoria', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre, frases: [] })
                });
                if (!res.ok) throw new Error(await res.text());
                categoriasFrases[nombre] = [];
                document.getElementById('nuevaCategoriaInput').value = '';
                seleccionarCategoria(nombre);
                renderCategorias();
                mostrarNotificacion('Categoría creada', 'success');
            } catch (e) {
                mostrarNotificacion('Error creando categoría', 'danger');
            }
        }

        async function eliminarCategoriaActual() {
            if (!categoriaSeleccionada) return;
            if (!confirm('¿Eliminar la categoría y todas sus frases?')) return;
            try {
                const res = await fetch(`/api/frases/categoria/${encodeURIComponent(categoriaSeleccionada)}`, { method: 'DELETE' });
                if (!res.ok) throw new Error(await res.text());
                delete categoriasFrases[categoriaSeleccionada];
                categoriaSeleccionada = null;
                renderCategorias();
                document.getElementById('tituloCategoria').innerHTML = 'Frases de: <em>—</em>';
                document.getElementById('btnEliminarCategoria').disabled = true;
                document.getElementById('listaFrases').innerHTML = '';
                mostrarNotificacion('Categoría eliminada', 'success');
            } catch (e) {
                mostrarNotificacion('Error eliminando categoría', 'danger');
            }
        }

        async function agregarFrase() {
            const input = document.getElementById('nuevaFraseInput');
            const frase = (input.value || '').trim();
            if (!categoriaSeleccionada) {
                mostrarNotificacion('Selecciona una categoría antes de añadir frases', 'warning');
                return;
            }
            if (!frase) {
                mostrarNotificacion('Introduce una frase antes de añadir', 'warning');
                return;
            }
            try {
                const res = await fetch('/api/frases/frase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoria: categoriaSeleccionada, frase })
                });
                if (!res.ok) {
                    let detalle = '';
                    try { const err = await res.json(); detalle = err.detail || JSON.stringify(err); } catch {}
                    throw new Error(detalle || 'Solicitud inválida');
                }
                categoriasFrases[categoriaSeleccionada] = categoriasFrases[categoriaSeleccionada] || [];
                if (!categoriasFrases[categoriaSeleccionada].some(f => f.toLowerCase() === frase.toLowerCase())) {
                    categoriasFrases[categoriaSeleccionada].push(frase);
                }
                input.value = '';
                renderCategorias();
                renderFrases();
                mostrarNotificacion('Frase añadida', 'success');
                // Si la frase nueva coincide con la búsqueda, permanecerá visible; si no, limpiar búsqueda
                if (fraseQuery && !frase.toLowerCase().includes(fraseQuery.toLowerCase())) {
                    fraseQuery = '';
                    const buscarInput = document.getElementById('buscarFraseInput');
                    if (buscarInput) buscarInput.value = '';
                    renderFrases();
                }
            } catch (e) {
                mostrarNotificacion('Error añadiendo frase: ' + (e.message || e), 'danger');
            }
        }

        async function reanalizarAnalisis() {
            try {
                // Llama al backend para recalcular el análisis y refrescar la home al cerrarse
                await fetch('/api/analizar');
                mostrarNotificacion('Análisis actualizado. Recarga la página para ver el ranking actualizado.', 'info');
            } catch {
                mostrarNotificacion('No se pudo lanzar el reanálisis.', 'warning');
            }
        }

        // Listeners de búsqueda y tamaño de página
        document.addEventListener('DOMContentLoaded', () => {
            const buscarInput = document.getElementById('buscarFraseInput');
            if (buscarInput) {
                buscarInput.addEventListener('input', (e) => {
                    fraseQuery = e.target.value || '';
                    frasePage = 1;
                    renderFrases();
                });
            }
            const perPageSel = document.getElementById('frasesPerPage');
            if (perPageSel) {
                perPageSel.addEventListener('change', (e) => {
                    frasesPerPage = parseInt(e.target.value) || 20;
                    frasePage = 1;
                    renderFrases();
                });
            }
            const buscarCatInput = document.getElementById('buscarCategoriaInput');
            if (buscarCatInput) {
                buscarCatInput.addEventListener('input', (e) => {
                    catQuery = e.target.value || '';
                    catPage = 1;
                    renderCategorias();
                });
            }
            const catsPerSel = document.getElementById('catsPerPage');
            if (catsPerSel) {
                catsPerSel.addEventListener('change', (e) => {
                    catsPerPage = parseInt(e.target.value) || 20;
                    catPage = 1;
                    renderCategorias();
                });
            }
        });

        async function eliminarFrase(fraseEncoded) {
            const frase = decodeURIComponent(fraseEncoded);
            if (!categoriaSeleccionada) return;
            try {
                const res = await fetch('/api/frases/frase', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoria: categoriaSeleccionada, frase })
                });
                if (!res.ok) throw new Error(await res.text());
                categoriasFrases[categoriaSeleccionada] = (categoriasFrases[categoriaSeleccionada] || []).filter(f => f.toLowerCase() !== frase.toLowerCase());
                renderCategorias();
                renderFrases();
                mostrarNotificacion('Frase eliminada', 'success');
            } catch (e) {
                mostrarNotificacion('Error eliminando frase', 'danger');
            }
        }

        async function renombrarCategoria(catEncoded) {
            const oldName = decodeURIComponent(catEncoded);
            const newName = prompt('Nuevo nombre para la categoría:', oldName);
            if (!newName || newName.trim() === '' || newName === oldName) return;
            try {
                const res = await fetch('/api/frases/categoria', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_name: oldName, new_name: newName.trim() })
                });
                if (!res.ok) throw new Error(await res.text());
                categoriasFrases[newName] = categoriasFrases[oldName] || [];
                delete categoriasFrases[oldName];
                categoriaSeleccionada = newName;
                renderCategorias();
                renderFrases();
                mostrarNotificacion('Categoría renombrada', 'success');
            } catch (e) {
                mostrarNotificacion('Error renombrando categoría', 'danger');
            }
        }

        async function editarFrase(fraseEncoded) {
            const oldFrase = decodeURIComponent(fraseEncoded);
            const newFrase = prompt('Editar frase:', oldFrase);
            if (!newFrase || newFrase.trim() === '' || newFrase === oldFrase) return;
            try {
                const res = await fetch('/api/frases/frase', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoria: categoriaSeleccionada, old_frase: oldFrase, new_frase: newFrase.trim() })
                });
                if (!res.ok) throw new Error(await res.text());
                categoriasFrases[categoriaSeleccionada] = (categoriasFrases[categoriaSeleccionada] || [])
                    .map(f => f.toLowerCase() === oldFrase.toLowerCase() ? newFrase.trim() : f)
                    .filter((f, idx, arr) => arr.findIndex(x => x.toLowerCase() === f.toLowerCase()) === idx);
                renderFrases();
                renderCategorias();
                mostrarNotificacion('Frase actualizada', 'success');
            } catch (e) {
                mostrarNotificacion('Error actualizando frase', 'danger');
            }
        }

        // Función para cargar datos del ranking
        function cargarDatosRanking() {
            try {
                const scriptTag = document.getElementById('rankingData');
                if (scriptTag && scriptTag.textContent) {
                    rankingGlobalData = JSON.parse(scriptTag.textContent.trim());
                    console.log('Datos del ranking cargados correctamente:', rankingGlobalData);
                    return true;
                } else {
                    console.error('No se encontró el script con datos del ranking');
                    return false;
                }
            } catch (error) {
                console.error('Error cargando datos del ranking:', error);
                return false;
            }
        }

        // Función para mostrar detalles de una frase
        function mostrarDetallesFrase(frase) {
            if (!rankingGlobalData || !rankingGlobalData[frase]) {
                mostrarNotificacion('No hay datos disponibles para esta frase', 'warning');
                return;
            }

            fraseSeleccionada = frase;
            const datos = rankingGlobalData[frase];
            
            const modalBody = document.getElementById('fraseModalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Información General</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Frase:</strong></td><td>${frase}</td></tr>
                            <tr><td><strong>Total Apariciones:</strong></td><td><span class="badge bg-primary">${datos.total}</span></td></tr>
                            <tr><td><strong>Porcentaje:</strong></td><td>${datos.total && window.totalApariciones ? ((datos.total / window.totalApariciones) * 100).toFixed(1) : '0.0'}%</td></tr>
                            <tr><td><strong>Posición Ranking:</strong></td><td>${obtenerPosicionRanking(frase)}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-success">Estadísticas</h6>
                        <div class="chart-container">
                            <canvas id="fraseChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-info">Ocurrencias Detalladas</h6>
                        ${generarTablaOcurrencias(datos.ocurrencias || [])}
                    </div>
                </div>
            `;
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('fraseModal'));
            modal.show();
            
            // Crear gráfico después de mostrar el modal
            setTimeout(() => crearGraficoFrase(frase, datos), 100);
        }

        // Función para ver una aparición específica en el documento
        function verAparicionEnDocumento(documento, posicion, frase, index) {
            console.log(`Navegando a aparición en ${documento}, posición ${posicion}, frase: ${frase}`);
            
            try {
                // Cerrar el modal actual
                const modal = bootstrap.Modal.getInstance(document.getElementById('fraseModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Mostrar notificación de navegación
                mostrarNotificacion(`Navegando a "${frase}" en ${documento}...`, 'info');
                
                // Construir URL de forma segura
                const url = `/api/documento/${encodeURIComponent(documento)}?highlight=${encodeURIComponent(frase)}&pos=${posicion}&index=${index}`;
                console.log(`URL generada: ${url}`);
                
                // Crear un enlace temporal y hacer clic en él
                const link = document.createElement('a');
                link.href = url;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                    
            } catch (error) {
                console.error('Error en verAparicionEnDocumento:', error);
                mostrarNotificacion(`Error al abrir el documento: ${error.message}`, 'danger');
            }
        }

        // Función para generar tabla de ocurrencias
        function generarTablaOcurrencias(ocurrencias) {
            if (!ocurrencias || ocurrencias.length === 0) {
                return '<p class="text-muted">No hay información detallada de ocurrencias disponible.</p>';
            }
            
            let tabla = '<div class="table-responsive"><table class="table table-sm table-striped">';
            tabla += '<thead><tr><th>Documento</th><th>Contexto</th><th>Posición</th><th>Acción</th></tr></thead><tbody>';
            
            ocurrencias.forEach((ocurrencia, index) => {
                const documento = ocurrencia.archivo || ocurrencia.documento || 'N/A';
                const contexto = ocurrencia.contexto || 'N/A';
                const posicion = ocurrencia.posicion || 'N/A';
                
                tabla += `<tr>
                    <td><strong>${documento}</strong></td>
                    <td>
                        <div class="contexto-texto" style="max-height: 60px; overflow: hidden; font-size: 0.9em;">
                            ${contexto}
                        </div>
                    </td>
                    <td><span class="badge bg-secondary">${posicion}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" 
                                onclick="verAparicionEnDocumento('${documento}', ${posicion}, '${ocurrencia.frase || ''}', ${index})"
                                title="Ver en documento">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    </td>
                </tr>`;
            });
            
            tabla += '</tbody></table></div>';
            return tabla;
        }

        // Función para crear gráfico de la frase
        function crearGraficoFrase(frase, datos) {
            const ctx = document.getElementById('fraseChart');
            if (!ctx) return;
            
            // Destruir gráfico existente si hay uno
            if (window.fraseChart && typeof window.fraseChart.destroy === 'function') {
                try {
                    window.fraseChart.destroy();
                } catch (e) {
                    console.warn('Error al destruir gráfico anterior:', e);
                }
            }
            
            // Datos para el gráfico
            const chartData = {
                labels: ['Esta Frase', 'Otras Frases'],
                datasets: [{
                    label: 'Apariciones',
                    data: [datos.total, window.totalApariciones - datos.total],
                    backgroundColor: ['#007bff', '#e9ecef'],
                    borderColor: ['#0056b3', '#adb5bd'],
                    borderWidth: 2
                }]
            };
            
            try {
                window.fraseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: `Distribución de "${frase}"`
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Error al crear gráfico:', e);
                // Mostrar mensaje de error en lugar del gráfico
                ctx.innerHTML = '<div class="alert alert-warning">No se pudo crear el gráfico</div>';
            }
        }

        // Función para comparar frases
        function compararFrase(frase) {
            if (!rankingGlobalData || !rankingGlobalData[frase]) {
                mostrarNotificacion('No hay datos disponibles para esta frase', 'warning');
                return;
            }

            fraseComparacion = frase;
            const datos = rankingGlobalData[frase];
            
            // Obtener top 5 frases para comparar
            const frasesComparables = Object.entries(rankingGlobalData)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 5)
                .filter(([f, _]) => f !== frase);
            
            const modalBody = document.getElementById('comparacionModalBody');
            modalBody.innerHTML = `
                <h6 class="text-success mb-3">Comparando: <strong>${frase}</strong></h6>
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">${frase}</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Apariciones:</span>
                                <span class="badge bg-primary">${datos.total}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Porcentaje:</span>
                                <span>${((datos.total / window.totalApariciones) * 100).toFixed(1)}%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Posición:</span>
                                <span>${obtenerPosicionRanking(frase)}</span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-info">Otras Frases Principales</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr><th>Frase</th><th>Apariciones</th><th>%</th></tr>
                                </thead>
                                <tbody>
                                    ${frasesComparables.map(([f, d]) => `
                                        <tr>
                                            <td>${f}</td>
                                            <td><span class="badge bg-secondary">${d.total}</span></td>
                                            <td>${((d.total / window.totalApariciones) * 100).toFixed(1)}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="chart-container">
                            <canvas id="comparacionChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('comparacionModal'));
            modal.show();
            
            // Crear gráfico de comparación
            setTimeout(() => crearGraficoComparacion(frase, frasesComparables), 100);
        }

        // Función para crear gráfico de comparación
        function crearGraficoComparacion(frase, frasesComparables) {
            const ctx = document.getElementById('comparacionChart');
            if (!ctx) return;
            
            // Destruir gráfico existente si hay uno
            if (window.comparacionChart) {
                window.comparacionChart.destroy();
            }
            
            const datos = rankingGlobalData[frase];
            const chartData = {
                labels: [frase, ...frasesComparables.map(([f, _]) => f)],
                datasets: [{
                    label: 'Apariciones',
                    data: [datos.total, ...frasesComparables.map(([_, d]) => d.total)],
                    backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'],
                    borderWidth: 2
                }]
            };
            
            window.comparacionChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Comparación de Apariciones'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Función para resaltar frase en el ranking
        function resaltarFrase(frase) {
            // Remover resaltado previo
            document.querySelectorAll('.ranking-row').forEach(row => {
                row.classList.remove('table-warning');
            });
            
            // Resaltar la fila seleccionada
            const fila = document.querySelector(`[data-frase="${frase}"]`);
            if (fila) {
                fila.classList.add('table-warning');
                fila.scrollIntoView({ behavior: 'smooth', block: 'center' });
                mostrarNotificacion(`Frase "${frase}" resaltada en el ranking`, 'info');
            }
        }

        // Función para obtener posición en el ranking
        function obtenerPosicionRanking(frase) {
            if (!rankingGlobalData) return 'N/A';
            
            const frases = Object.entries(rankingGlobalData)
                .sort((a, b) => b[1].total - a[1].total);
            
            const posicion = frases.findIndex(([f, _]) => f === frase);
            return posicion !== -1 ? posicion + 1 : 'N/A';
        }

        // Función para aplicar filtros
        function aplicarFiltros() {
            const searchTerm = document.getElementById('searchFrase').value.toLowerCase();
            const minApariciones = parseInt(document.getElementById('minApariciones').value) || 1;
            const orden = document.getElementById('ordenRanking').value;
            
            const filas = document.querySelectorAll('.ranking-row');
            let filasVisibles = 0;
            
            filas.forEach(fila => {
                const frase = fila.getAttribute('data-frase').toLowerCase();
                const total = parseInt(fila.getAttribute('data-total'));
                
                const cumpleBusqueda = frase.includes(searchTerm);
                const cumpleMinimo = total >= minApariciones;
                
                if (cumpleBusqueda && cumpleMinimo) {
                    fila.style.display = '';
                    filasVisibles++;
                } else {
                    fila.style.display = 'none';
                }
            });
            
            // Reordenar filas según el criterio seleccionado
            reordenarRanking(orden);
            
            mostrarNotificacion(`Mostrando ${filasVisibles} frases que cumplen los filtros`, 'success');
        }

        // Función para reordenar ranking
        function reordenarRanking(orden) {
            const tbody = document.querySelector('#rankingTable tbody');
            const filas = Array.from(tbody.querySelectorAll('.ranking-row'));
            
            filas.sort((a, b) => {
                const fraseA = a.getAttribute('data-frase');
                const fraseB = b.getAttribute('data-frase');
                const totalA = parseInt(a.getAttribute('data-total'));
                const totalB = parseInt(b.getAttribute('data-total'));
                
                switch (orden) {
                    case 'total':
                        return totalB - totalA;
                    case 'porcentaje':
                        const porcentajeA = (totalA / window.totalApariciones) * 100;
                        const porcentajeB = (totalB / window.totalApariciones) * 100;
                        return porcentajeB - porcentajeA;
                    case 'alfabetico':
                        return fraseA.localeCompare(fraseB);
                    default:
                        return 0;
                }
            });
            
            // Reinsertar filas en el nuevo orden
            filas.forEach((fila, index) => {
                const numero = fila.querySelector('td:first-child');
                numero.textContent = index + 1;
                tbody.appendChild(fila);
            });
        }

        // Función para mostrar gráfico del ranking
        function mostrarGraficoRanking() {
            if (!rankingGlobalData) {
                mostrarNotificacion('No hay datos disponibles para el gráfico', 'warning');
                return;
            }
            
            // Crear modal para el gráfico
            const modalHTML = `
                <div class="modal fade" id="graficoModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-graph-up me-2"></i>Gráfico del Ranking
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="chart-container">
                                    <canvas id="rankingChart"></canvas>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Agregar modal al DOM si no existe
            if (!document.getElementById('graficoModal')) {
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('graficoModal'));
            modal.show();
            
            // Crear gráfico
            setTimeout(() => crearGraficoRanking(), 100);
        }

        // Función para crear gráfico del ranking
        function crearGraficoRanking() {
            const canvas = document.getElementById('rankingChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            // Destruir gráfico existente si hay uno (compatibilidad Chart.js v3/v4)
            let existingChart = null;
            if (typeof Chart !== 'undefined' && typeof Chart.getChart === 'function') {
                existingChart = Chart.getChart(canvas) || null;
            } else if (window.rankingChart && typeof window.rankingChart.destroy === 'function') {
                existingChart = window.rankingChart;
            }
            if (existingChart && typeof existingChart.destroy === 'function') {
                existingChart.destroy();
                window.rankingChart = null;
            }
            
            // Obtener top 10 frases
            const topFrases = Object.entries(rankingGlobalData)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 10);
            
            const chartData = {
                labels: topFrases.map(([f, _]) => f.length > 20 ? f.substring(0, 20) + '...' : f),
                datasets: [{
                    label: 'Apariciones',
                    data: topFrases.map(([_, d]) => d.total),
                    backgroundColor: 'rgba(0, 123, 255, 0.8)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 2
                }]
            };
            
            window.rankingChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Top 10 Frases Clave por Apariciones'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Función para exportar ranking
        function exportarRanking() {
            if (!rankingGlobalData) {
                mostrarNotificacion('No hay datos disponibles para exportar', 'warning');
                return;
            }
            
            const frases = Object.entries(rankingGlobalData)
                .sort((a, b) => b[1].total - a[1].total)
                .map(([frase, datos], index) => ({
                    posicion: index + 1,
                    frase: frase,
                    apariciones: datos.total,
                    porcentaje: ((datos.total / window.totalApariciones) * 100).toFixed(1)
                }));
            
            const csv = [
                ['Posición', 'Frase Clave', 'Apariciones', 'Porcentaje'],
                ...frases.map(f => [f.posicion, f.frase, f.apariciones, f.porcentaje + '%'])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ranking_frases_clave.csv';
            link.click();
            
            mostrarNotificacion('Ranking exportado como CSV', 'success');
        }

        // Función para exportar detalles de frase
        function exportarFraseDetalle() {
            if (!fraseSeleccionada || !rankingGlobalData[fraseSeleccionada]) {
                mostrarNotificacion('No hay frase seleccionada para exportar', 'warning');
                return;
            }
            
            const datos = rankingGlobalData[fraseSeleccionada];
            const contenido = `Detalles de Frase Clave: ${fraseSeleccionada}\n\n` +
                            `Total Apariciones: ${datos.total}\n` +
                            `Porcentaje: ${((datos.total / window.totalApariciones) * 100).toFixed(1)}%\n` +
                            `Posición en Ranking: ${obtenerPosicionRanking(fraseSeleccionada)}\n\n` +
                            `Ocurrencias:\n${JSON.stringify(datos.ocurrencias || [], null, 2)}`;
            
            const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `detalle_${fraseSeleccionada.replace(/[^a-zA-Z0-9]/g, '_')}.txt`;
            link.click();
            
            mostrarNotificacion('Detalles de frase exportados', 'success');
        }

        // ===== FUNCIONES PARA DOCUMENTOS =====

        // Función para mostrar detalles de un documento específico
        function mostrarDetallesDocumento(nombreArchivo) {
            // Obtener datos del documento desde el backend
            fetch(`/api/documento-info/${encodeURIComponent(nombreArchivo)}`)
                .then(response => response.json())
                .then(data => {
                    const modalBody = document.getElementById('documentoModalBody');
                    const modalTitle = document.getElementById('documentoModalLabel');
                    
                    modalTitle.innerHTML = `<i class="bi bi-file-text me-2"></i>${nombreArchivo}`;
                    
                    if (data.error) {
                        modalBody.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Error al obtener detalles: ${data.error}
                            </div>
                        `;
                    } else {
                        modalBody.innerHTML = generarContenidoDocumento(nombreArchivo, data);
                    }
                    
                    // Mostrar modal
                    const modal = new bootstrap.Modal(document.getElementById('documentoModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error obteniendo detalles del documento:', error);
                    mostrarNotificacion('Error obteniendo detalles del documento', 'danger');
                });
        }

        // Función para generar contenido del modal de documento
        function generarContenidoDocumento(nombreArchivo, datos) {
            let contenido = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Información del Documento</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Nombre:</strong></td><td>${nombreArchivo}</td></tr>
                            <tr><td><strong>Estado:</strong></td><td>
                                ${datos.procesado ? 
                                    '<span class="badge bg-success">Procesado</span>' : 
                                    '<span class="badge bg-danger">Error</span>'
                                }
                            </td></tr>
                            <tr><td><strong>Tipo:</strong></td><td>${nombreArchivo.split('.').pop().toUpperCase()}</td></tr>
                            <tr><td><strong>Tamaño:</strong></td><td>${datos.tamaño || 'N/A'}</td></tr>
                            <tr><td><strong>Fecha Procesamiento:</strong></td><td>${datos.fecha_procesamiento || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-success">Estadísticas de Análisis</h6>
                        <div class="row">
                            <div class="col-6">
                                <div class="card bg-light text-center p-3">
                                    <h4 class="text-primary mb-1">${datos.frases_clave ? Object.keys(datos.frases_clave).length : 0}</h4>
                                    <small class="text-muted">Categorías</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light text-center p-3">
                                    <h4 class="text-success mb-1">${datos.total_frases || 0}</h4>
                                    <small class="text-muted">Frases Clave</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (datos.frases_clave && Object.keys(datos.frases_clave).length > 0) {
                contenido += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-info">Frases Clave Encontradas</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Categoría</th>
                                            <th>Frases</th>
                                            <th>Apariciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                Object.entries(datos.frases_clave).forEach(([categoria, info]) => {
                    contenido += `
                        <tr>
                            <td><strong>${categoria.replace(/_/g, ' ').toUpperCase()}</strong></td>
                            <td>${info.frases ? info.frases.join(', ') : 'N/A'}</td>
                            <td><span class="badge bg-primary">${info.total}</span></td>
                        </tr>
                    `;
                });
                
                contenido += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (datos.error) {
                contenido += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-danger">
                                <h6 class="text-danger">Error en Procesamiento</h6>
                                <p class="mb-0">${datos.error}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            return contenido;
        }

        // Función para mostrar detalles generales de todos los documentos
        function mostrarDetallesDocumentos() {
            const modalBody = document.getElementById('documentosGeneralesModalBody');
            
            // Obtener datos de los documentos desde la variable global
            const documentos = window.documentosData;
            
            if (!documentos || Object.keys(documentos).length === 0) {
                modalBody.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No hay documentos disponibles para mostrar.
                    </div>
                `;
            } else {
                let contenido = `
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="text-primary">Resumen de Documentos</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white text-center p-3">
                                        <h4 class="mb-1">${Object.keys(documentos).length}</h4>
                                        <small>Total Documentos</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white text-center p-3">
                                        <h4 class="mb-1">${Object.values(documentos).filter(d => d.procesado).length}</h4>
                                        <small>Procesados</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white text-center p-3">
                                        <h4 class="mb-1">${Object.values(documentos).filter(d => !d.procesado).length}</h4>
                                        <small>Con Errores</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white text-center p-3">
                                        <h4 class="mb-1">${Object.values(documentos).reduce((sum, d) => sum + (d.total_frases || 0), 0)}</h4>
                                        <small>Total Frases</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-success">Lista Detallada</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Documento</th>
                                            <th>Estado</th>
                                            <th>Categorías</th>
                                            <th>Frases</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                Object.entries(documentos).forEach(([nombre, datos]) => {
                    contenido += `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    ${nombre.endsWith('.pdf') ? '<i class="bi bi-file-pdf text-danger me-2"></i>' : 
                                      nombre.endsWith('.txt') ? '<i class="bi bi-file-text text-primary me-2"></i>' : 
                                      '<i class="bi bi-file-earmark text-secondary me-2"></i>'}
                                    <span title="${nombre}">${nombre.length > 30 ? nombre.substring(0, 30) + '...' : nombre}</span>
                                </div>
                            </td>
                            <td>
                                ${datos.procesado ? 
                                    '<span class="badge bg-success">Procesado</span>' : 
                                    '<span class="badge bg-danger">Error</span>'
                                }
                            </td>
                            <td>
                                <span class="badge bg-info">${datos.frases_clave ? Object.keys(datos.frases_clave).length : 0}</span>
                            </td>
                            <td>
                                <span class="badge bg-secondary">${datos.total_frases || 0}</span>
                            </td>
                            <td>
                                <button class="btn btn-outline-primary btn-sm" onclick="mostrarDetallesDocumento('${nombre}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                contenido += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                modalBody.innerHTML = contenido;
            }
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('documentosGeneralesModal'));
            modal.show();
        }

        // Función para ver el documento (descargar o abrir)
        function verDocumento(nombreArchivo) {
            // Usar la ruta directa de vista de archivo
            const url = `/api/documento/${encodeURIComponent(nombreArchivo)}`;
            window.open(url, '_blank');
        }

        async function generarDemandaDesde(nombreArchivo) {
            try {
                const resp = await fetch('/api/demanda-base/txt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombres_archivo: [nombreArchivo] })
                });
                if (!resp.ok) {
                    mostrarNotificacion('Error generando demanda base', 'danger');
                    return;
                }
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `demanda_base_${nombreArchivo.replace(/[^a-zA-Z0-9_\.\-]/g,'_')}.txt`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                mostrarNotificacion('Demanda base generada', 'success');
            } catch (e) {
                mostrarNotificacion('Error: ' + (e.message || e), 'danger');
            }
        }

        function analizarDiscrepancias(nombreArchivo) {
            try {
                // Extraer ID del archivo (nombre sin extensión)
                const archivoId = nombreArchivo.replace(/\.[^/.]+$/, "");
                const url = `/analisis-discrepancias/${encodeURIComponent(archivoId)}`;
                window.open(url, '_blank');
                mostrarNotificacion('Abriendo análisis de discrepancias...', 'info');
            } catch (e) {
                mostrarNotificacion('Error: ' + (e.message || e), 'danger');
            }
        }

        // Función para exportar lista de documentos
        function exportarDocumentos() {
            const documentos = window.documentosData;
            
            if (!documentos || Object.keys(documentos).length === 0) {
                mostrarNotificacion('No hay documentos para exportar', 'warning');
                return;
            }
            
            const csv = [
                ['Documento', 'Estado', 'Categorías', 'Total Frases', 'Error'],
                ...Object.entries(documentos).map(([nombre, datos]) => [
                    nombre,
                    datos.procesado ? 'Procesado' : 'Error',
                    datos.frases_clave ? Object.keys(datos.frases_clave).length : 0,
                    datos.total_frases || 0,
                    datos.error || 'N/A'
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            
            const csvBlob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const csvLink = document.createElement('a');
            csvLink.href = URL.createObjectURL(csvBlob);
            csvLink.download = 'documentos_analizados.csv';
            csvLink.click();
            
            mostrarNotificacion('Lista de documentos exportada', 'success');
        }

        // Función para exportar detalles de documento
        function exportarDocumentoDetalle() {
            // Esta función se implementará cuando se seleccione un documento
            mostrarNotificacion('Función de exportación de documento en desarrollo', 'info');
        }

        // Función para exportar resumen de documentos
        function exportarResumenDocumentos() {
            const documentos = window.documentosData;
            
            if (!documentos || Object.keys(documentos).length === 0) {
                mostrarNotificacion('No hay documentos para exportar', 'warning');
                return;
            }
            
            const resumen = `RESUMEN DE DOCUMENTOS ANALIZADOS\n` +
                           `================================\n\n` +
                           `Total de Documentos: ${Object.keys(documentos).length}\n` +
                           `Documentos Procesados: ${Object.values(documentos).filter(d => d.procesado).length}\n` +
                           `Documentos con Errores: ${Object.values(documentos).filter(d => !d.procesado).length}\n` +
                           `Total de Frases Clave: ${Object.values(documentos).reduce((sum, d) => sum + (d.total_frases || 0), 0)}\n\n` +
                           `DETALLES POR DOCUMENTO:\n` +
                           `======================\n\n` +
                           Object.entries(documentos).map(([nombre, datos]) => 
                               `${nombre}:\n` +
                               `  Estado: ${datos.procesado ? 'Procesado' : 'Error'}\n` +
                               `  Categorías: ${datos.frases_clave ? Object.keys(datos.frases_clave).length : 0}\n` +
                               `  Frases: ${datos.total_frases || 0}\n` +
                               `  ${datos.error ? `Error: ${datos.error}` : ''}\n`
                           ).join('\n');
            
            const resumenBlob = new Blob([resumen], { type: 'text/plain;charset=utf-8;' });
            const resumenLink = document.createElement('a');
            resumenLink.href = URL.createObjectURL(resumenBlob);
            resumenLink.download = 'resumen_documentos.txt';
            resumenLink.click();
            
            mostrarNotificacion('Resumen de documentos exportado', 'success');
        }

        // ===== GESTOR DE DOCUMENTOS (ELIMINAR) =====
        let docsListado = [];
        let docsFiltro = '';

        function setLoading(show, text) {
            const ov = document.getElementById('globalLoading');
            if (!ov) return;
            const t = document.getElementById('globalLoadingText');
            if (t && text) t.textContent = text;
            ov.classList.toggle('d-none', !show);
        }

        async function fetchWithRetry(url, options = {}, cfg = {}) {
            const { retries = 2, timeoutMs = 15000, retryOn = [500, 502, 503, 504], retryDelayMs = 800 } = cfg;
            let attempt = 0;
            while (true) {
                attempt += 1;
                const ctrl = (typeof AbortController !== 'undefined') ? new AbortController() : null;
                const to = ctrl ? setTimeout(() => ctrl.abort(), timeoutMs) : null;
                try {
                    const resp = await fetch(url, { ...options, signal: ctrl ? ctrl.signal : undefined });
                    if (!resp.ok && retryOn.includes(resp.status) && attempt <= retries) {
                        await new Promise(r => setTimeout(r, retryDelayMs * attempt));
                        continue;
                    }
                    if (to) clearTimeout(to);
                    return resp;
                } catch (e) {
                    if (to) clearTimeout(to);
                    if (attempt <= retries) {
                        await new Promise(r => setTimeout(r, retryDelayMs * attempt));
                        continue;
                    }
                    throw e;
                }
            }
        }

        function abrirGestorDocumentos() {
            setLoading(true, 'Cargando documentos…');
            cargarDocumentos().then(() => {
                const modal = new bootstrap.Modal(document.getElementById('gestorDocumentosModal'));
                modal.show();
                setLoading(false);
            });
        }

        async function cargarDocumentos() {
            try {
                const res = await fetchWithRetry('/api/documentos');
                const data = await res.json();
                docsListado = data.documentos || [];
                renderListadoDocs();
                // Listener de búsqueda
                const input = document.getElementById('buscarDocumentoInput');
                if (input && !input._binded) {
                    input.addEventListener('input', (e) => {
                        docsFiltro = e.target.value || '';
                        renderListadoDocs();
                    });
                    input._binded = true;
                }
            } catch (e) {
                mostrarNotificacion('No se pudieron cargar los documentos', 'danger');
            }
        }

        function renderListadoDocs() {
            const tbody = document.getElementById('tablaDocumentosBody');
            const resumen = document.getElementById('docsResumen');
            if (!tbody) return;
            tbody.innerHTML = '';
            const lista = docsFiltro
                ? docsListado.filter(d => (d.nombre || '').toLowerCase().includes(docsFiltro.toLowerCase()))
                : docsListado.slice();
            if (resumen) resumen.textContent = `${lista.length} documento(s)`;
            if (!lista.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-muted">Sin documentos</td></tr>';
                return;
            }
            function inferirInstanciaPorNombre(nombre) {
                const n = (nombre || '').toLowerCase();
                if (n.includes('ts_') || n.includes('tribunal_supremo') || n.includes('ts-') || n.includes(' ts ')) return 'TS';
                if (n.includes('tsj') || n.includes('tribunal_superior')) return 'TSJ';
                return '';
            }
            lista.forEach(doc => {
                const inst = inferirInstanciaPorNombre(doc.nombre);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td title="${doc.nombre}">${doc.nombre}</td>
                    <td>
                        <span class="badge ${doc.carpeta === 'sentencias' ? 'bg-primary' : 'bg-secondary'}">${doc.carpeta}</span>
                        ${inst ? `<span class="badge bg-warning text-dark ms-1" title="Instancia">${inst}</span>` : ''}
                    </td>
                    <td>${formatearBytes(doc.tamaño || 0)}</td>
                    <td>${(doc.modificado || '').replace('T',' ').slice(0,19)}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger" title="Eliminar" onclick="eliminarDocumento('${encodeURIComponent(doc.nombre)}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function formatearBytes(bytes) {
            const sizes = ['B','KB','MB','GB'];
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return `${(bytes / Math.pow(1024, i)).toFixed(1)} ${sizes[i]}`;
        }

        async function eliminarDocumento(nombreEncoded) {
            const nombre = decodeURIComponent(nombreEncoded);
            if (!confirm(`¿Eliminar definitivamente "${nombre}"?`)) return;
            try {
                setLoading(true, 'Eliminando documento…');
                const res = await fetchWithRetry('/api/documentos', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre_archivo: nombre })
                }, { retries: 1, timeoutMs: 20000 });
                if (!res.ok) {
                    let detalle = '';
                    try { const err = await res.json(); detalle = err.detail || JSON.stringify(err); } catch {}
                    setLoading(false);
                    throw new Error(detalle || 'No se pudo eliminar');
                }
                // quitar de la lista y refrescar
                docsListado = docsListado.filter(d => d.nombre !== nombre);
                renderListadoDocs();
                mostrarNotificacion('Documento eliminado', 'success');
                setLoading(false);
            } catch (e) {
                mostrarNotificacion('Error eliminando documento: ' + (e.message || e), 'danger');
                setLoading(false);
            }
        }

        // Función para debug de datos de frases
        function debugFraseData() {
            console.log('=== DEBUG: Datos de frases ===');
            
            if (!rankingGlobalData) {
                console.error('No hay datos del ranking disponibles');
                return;
            }
            
            console.log('Datos del ranking:', rankingGlobalData);
            console.log(`Total de categorías: ${Object.keys(rankingGlobalData).length}`);
            
            const elementos = document.querySelectorAll('[data-frase]');
            console.log(`Elementos encontrados: ${elementos.length}`);
            
            elementos.forEach((elemento, index) => {
                const frase = elemento.getAttribute('data-frase');
                const fraseIndex = elemento.getAttribute('data-frase-index');
                
                console.log(`Elemento ${index + 1}:`);
                console.log(`  Frase: ${frase}`);
                console.log(`  Índice: ${fraseIndex}`);
                
                if (rankingGlobalData && rankingGlobalData[frase]) {
                    const datos = rankingGlobalData[frase];
                    console.log(`  Datos disponibles:`, datos);
                    console.log(`  Total: ${datos.total}`);
                    console.log(`  Ocurrencias: ${datos.ocurrencias ? datos.ocurrencias.length : 0}`);
                } else {
                    console.error(`  No hay datos para la frase: ${frase}`);
                }
                console.log('---');
            });
        }

        // Función para probar búsqueda de argumentos
        function testBusquedaArgumentos() {
            console.log('=== TEST: Búsqueda de Argumentos ===');
            mostrarNotificacion('Test de búsqueda ejecutado', 'info');
        }

        // Función para verificar backend
        async function verificarDatosBackend() {
            try {
                const response = await fetch('/api/analizar');
                const data = await response.json();
                console.log('Backend responde:', data);
                mostrarNotificacion('Backend verificado correctamente', 'success');
            } catch (error) {
                console.error('Error backend:', error);
                mostrarNotificacion('Error verificando backend', 'danger');
            }
        }

        // Función para análisis inteligente
        async function mostrarAnalisisInteligente() {
            try {
                const response = await fetch('/api/analizar');
                const datos = await response.json();
                console.log('Análisis inteligente:', datos);
                mostrarNotificacion('Análisis inteligente ejecutado', 'success');
            } catch (error) {
                console.error('Error análisis:', error);
                mostrarNotificacion('Error en análisis inteligente', 'danger');
            }
        }

        // Función para debug avanzado
        async function debugAvanzado() {
            console.log('=== DEBUG AVANZADO ===');
            mostrarNotificacion('Debug avanzado ejecutado', 'info');
        }

        // Función de prueba
        function testShowFraseDetails() {
            console.log('=== TEST: showFraseDetails ===');
            mostrarNotificacion('Test ejecutado correctamente', 'success');
        }

        // Función para limpiar caché
        async function limpiarCache() {
            try {
                const response = await fetch('/api/limpiar-cache', {
                    method: 'POST'
                });
                const data = await response.json();
                mostrarNotificacion('Caché limpiado correctamente', 'success');
                // Recargar la página para obtener datos frescos
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } catch (error) {
                console.error('Error limpiando caché:', error);
                mostrarNotificacion('Error limpiando caché', 'danger');
            }
        }

        // ===== FUNCIONES PARA SUBIDA DE ARCHIVOS =====
        
        // Función para manejar la subida de archivos
        async function subirArchivo(archivo) {
            const formData = new FormData();
            formData.append('archivo', archivo);
            
            try {
                const response = await fetch('/api/subir-documento', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Error subiendo archivo');
                }
                
                const result = await response.json();
                return result;
                
            } catch (error) {
                console.error('Error subiendo archivo:', error);
                throw error;
            }
        }
        
        // Función para mostrar progreso de subida
        function mostrarProgresoSubida(mostrar = true) {
            const progressDiv = document.getElementById('uploadProgress');
            const btnSubir = document.getElementById('btnSubir');
            
            if (mostrar) {
                progressDiv.style.display = 'block';
                btnSubir.disabled = true;
                btnSubir.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Subiendo...';
            } else {
                progressDiv.style.display = 'none';
                btnSubir.disabled = false;
                btnSubir.innerHTML = '<i class="bi bi-upload me-2"></i>Subir Documento';
            }
        }
        
        // Función para mostrar resultado de subida
        function mostrarResultadoSubida(exito, mensaje, detalles = null) {
            const resultDiv = document.getElementById('uploadResult');
            
            if (exito) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>¡Archivo subido correctamente!</strong><br>
                        ${mensaje}
                        ${detalles ? `<br><small class="text-muted">${detalles}</small>` : ''}
                    </div>
                `;
                // Limpiar el formulario
                document.getElementById('archivoInput').value = '';
                // Recargar la página después de 2 segundos para mostrar el nuevo documento
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Error subiendo archivo:</strong><br>
                        ${mensaje}
                    </div>
                `;
            }
            
            resultDiv.style.display = 'block';
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, inicializando aplicación...');
            
            // Cargar datos del ranking
            if (cargarDatosRanking()) {
                console.log('Aplicación inicializada correctamente');
            } else {
                console.error('Error inicializando la aplicación');
            }
            
            // Configurar event listeners para filtros con verificación de existencia
            const searchFrase = document.getElementById('searchFrase');
            if (searchFrase) {
                searchFrase.addEventListener('input', function() {
                    if (this.value.length >= 2 || this.value.length === 0) {
                        aplicarFiltros();
                    }
                });
            }
            
            const minApariciones = document.getElementById('minApariciones');
            if (minApariciones) {
                minApariciones.addEventListener('change', aplicarFiltros);
            }
            
            const ordenRanking = document.getElementById('ordenRanking');
            if (ordenRanking) {
                ordenRanking.addEventListener('change', aplicarFiltros);
            }
            
            // Event listener para el formulario de subida
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) {
                uploadForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const archivoInput = document.getElementById('archivoInput');
                    const archivo = archivoInput.files[0];
                    
                    if (!archivo) {
                        mostrarResultadoSubida(false, 'Por favor selecciona un archivo');
                        return;
                    }
                    
                    // Validar tamaño del archivo (10MB máximo)
                    if (archivo.size > 10 * 1024 * 1024) {
                        mostrarResultadoSubida(false, 'El archivo es demasiado grande. Máximo 10MB');
                        return;
                    }
                    
                    try {
                        mostrarProgresoSubida(true);
                        const resultado = await subirArchivo(archivo);
                        mostrarProgresoSubida(false);
                        mostrarResultadoSubida(true, resultado.mensaje, `Archivo: ${resultado.nombre_archivo}`);
                    } catch (error) {
                        mostrarProgresoSubida(false);
                        mostrarResultadoSubida(false, error.message);
                    }
                });
            }
        });
    </script>
</body>
</html>
