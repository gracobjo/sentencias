<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis de Discrepancias Médicas-Legales</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .discrepancy-card {
            border-left: 4px solid #dc3545;
            margin-bottom: 1rem;
        }
        .evidence-card {
            border-left: 4px solid #28a745;
            margin-bottom: 1rem;
        }
        .argument-card {
            border-left: 4px solid #007bff;
            margin-bottom: 1rem;
        }
        .recommendation-card {
            border-left: 4px solid #ffc107;
            margin-bottom: 1rem;
        }
        .probability-high {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        .probability-medium {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
        }
        .probability-low {
            background: linear-gradient(135deg, #dc3545, #e83e8c);
            color: white;
        }
        .severity-high {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .severity-medium {
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }
        .severity-low {
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
        .context-text {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.75rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .summary-executive {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .metric-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333 !important;
            min-height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .metric-label {
            font-size: 0.875rem;
            color: #6c757d;
        }

        /* Estilos responsive */
        @media (max-width: 768px) {
            .container-fluid {
                padding-left: 10px;
                padding-right: 10px;
            }
            
            .metric-value {
                font-size: 1.5rem;
            }
            
            .card {
                margin-bottom: 1rem;
            }
            
            .btn-group {
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .btn {
                margin-bottom: 0.5rem;
                width: 100%;
            }
            
            .navbar-brand {
                font-size: 1.1rem;
            }
            
            .nav-link {
                padding: 0.5rem 0.75rem;
            }
            
            .table-responsive {
                font-size: 0.85rem;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .card-title {
                font-size: 1.1rem;
            }
            
            .h1, h1 {
                font-size: 1.8rem;
            }
            
            .h2, h2 {
                font-size: 1.5rem;
            }
            
            .h3, h3 {
                font-size: 1.3rem;
            }
            
            .h4, h4 {
                font-size: 1.1rem;
            }
            
            .h5, h5 {
                font-size: 1rem;
            }
            
            .summary-executive {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .metric-card {
                padding: 0.75rem;
                margin-bottom: 1rem;
            }
        }

        @media (max-width: 576px) {
            .container-fluid {
                padding-left: 5px;
                padding-right: 5px;
            }
            
            .metric-value {
                font-size: 1.2rem;
            }
            
            .metric-label {
                font-size: 0.8rem;
            }
            
            .card-body {
                padding: 0.75rem;
            }
            
            .btn {
                font-size: 0.9rem;
                padding: 0.5rem 0.75rem;
            }
            
            .navbar-brand {
                font-size: 1rem;
            }
            
            .table-responsive {
                font-size: 0.8rem;
            }
            
            .badge {
                font-size: 0.7rem;
            }
            
            .context-text {
                font-size: 0.8rem;
                padding: 0.5rem;
            }
            
            .summary-executive {
                padding: 0.75rem;
            }
            
            .metric-card {
                padding: 0.5rem;
            }
        }

        /* Mejoras para tablets */
        @media (min-width: 769px) and (max-width: 1024px) {
            .col-md-6 {
                flex: 0 0 50%;
                max-width: 50%;
            }
            
            .col-md-4 {
                flex: 0 0 33.333333%;
                max-width: 33.333333%;
            }
            
            .col-md-3 {
                flex: 0 0 25%;
                max-width: 25%;
            }
        }

        /* Animaciones suaves */
        .card {
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn {
            transition: all 0.3s ease;
        }
        
        /* Mejoras de accesibilidad */
        .btn:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }
        
        .card:focus-within {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-balance-scale"></i> Analizador Legal IA
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Inicio</a>
                <a class="nav-link" href="/subir">Subir Documentos</a>
                <a class="nav-link" href="/analisis-predictivo">Análisis Predictivo</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-search-plus text-primary"></i>
                    Análisis de Discrepancias Médicas-Legales
                </h1>
                
                {% if resultado %}
                <!-- Resumen Ejecutivo -->
                <div class="summary-executive">
                    <h2 class="mb-3">
                        <i class="fas fa-chart-line"></i> Resumen Ejecutivo
                    </h2>
                    <div class="row">
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12 mb-3">
                            <div class="metric-card">
                                <div class="metric-value" id="metric-discrepancias">-</div>
                                <div class="metric-label">Discrepancias Detectadas</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12 mb-3">
                            <div class="metric-card">
                                <div class="metric-value" id="metric-evidencia">-</div>
                                <div class="metric-label">Elementos de Evidencia</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12 mb-3">
                            <div class="metric-card">
                                <div class="metric-value" id="metric-puntuacion">-</div>
                                <div class="metric-label">Puntuación Discrepancia</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12 mb-3">
                            <div class="metric-card">
                                <div class="metric-value" id="metric-probabilidad">-</div>
                                <div class="metric-label">Probabilidad IPP</div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Resumen Ejecutivo Texto -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-file-alt"></i> Resumen Ejecutivo
                        </h5>
                    </div>
                    <div class="card-body">
                        <pre class="mb-0">{{ resultado.analisis_discrepancias.resumen_ejecutivo if resultado.analisis_discrepancias and resultado.analisis_discrepancias.resumen_ejecutivo else "Resumen no disponible" }}</pre>
                    </div>
                </div>

                <!-- Discrepancias Detectadas -->
                {% if resultado.analisis_discrepancias and resultado.analisis_discrepancias.discrepancias_detectadas %}
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle"></i> Discrepancias Detectadas
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for discrepancia in resultado.analisis_discrepancias.discrepancias_detectadas %}
                        <div class="card discrepancy-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title text-danger">
                                        <i class="fas fa-times-circle"></i> {{ discrepancia.tipo|title }}
                                    </h6>
                                    <span class="badge bg-{{ 'danger' if discrepancia.severidad == 'alta' else 'warning' if discrepancia.severidad == 'media' else 'info' }}">
                                        {{ discrepancia.severidad|upper }}
                                    </span>
                                </div>
                                <p class="card-text">{{ discrepancia.descripcion }}</p>
                                <div class="mt-3">
                                    <h6 class="text-primary">Argumento Jurídico:</h6>
                                    <p class="text-muted">{{ discrepancia.argumento_juridico }}</p>
                                </div>
                                {% if discrepancia.evidencia %}
                                <div class="mt-3">
                                    <h6 class="text-success">Evidencia:</h6>
                                    <ul class="list-unstyled">
                                        {% for ev in discrepancia.evidencia %}
                                        <li><i class="fas fa-check text-success"></i> {{ ev.texto }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Evidencia Favorable -->
                {% if resultado.analisis_discrepancias and resultado.analisis_discrepancias.evidencia_favorable %}
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-check-circle"></i> Evidencia Favorable para IPP
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for evidencia in resultado.analisis_discrepancias.evidencia_favorable %}
                        <div class="card evidence-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title text-success">
                                        <i class="fas fa-medical-kit"></i> {{ evidencia.tipo|title }}
                                    </h6>
                                    <span class="badge bg-{{ 'success' if evidencia.relevancia == 'alta' else 'warning' if evidencia.relevancia == 'media' else 'info' }}">
                                        {{ evidencia.relevancia|upper }}
                                    </span>
                                </div>
                                <p class="card-text">{{ evidencia.descripcion }}</p>
                                <div class="mt-3">
                                    <h6 class="text-primary">Argumento:</h6>
                                    <p class="text-muted">{{ evidencia.argumento }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Argumentos Jurídicos -->
                {% if resultado.analisis_discrepancias and resultado.analisis_discrepancias.argumentos_juridicos %}
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-gavel"></i> Argumentos Jurídicos Generados
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for argumento in resultado.analisis_discrepancias.argumentos_juridicos %}
                        <div class="card argument-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title text-info">
                                        <i class="fas fa-balance-scale"></i> {{ argumento.titulo }}
                                    </h6>
                                    <span class="badge bg-{{ 'success' if argumento.fuerza == 'alta' else 'warning' if argumento.fuerza == 'media' else 'secondary' }}">
                                        {{ argumento.fuerza|upper }}
                                    </span>
                                </div>
                                <p class="card-text">{{ argumento.contenido }}</p>
                                {% if argumento.evidencia_soporte %}
                                <div class="mt-3">
                                    <h6 class="text-success">Evidencia de Soporte:</h6>
                                    <ul class="list-unstyled">
                                        {% for ev in argumento.evidencia_soporte %}
                                        <li><i class="fas fa-check text-success"></i> {{ ev }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Recomendaciones de Defensa -->
                {% if resultado.analisis_discrepancias and resultado.analisis_discrepancias.recomendaciones_defensa %}
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-lightbulb"></i> Recomendaciones para la Defensa
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for recomendacion in resultado.analisis_discrepancias.recomendaciones_defensa %}
                        <div class="card recommendation-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title text-warning">
                                        <i class="fas fa-star"></i> {{ recomendacion.titulo }}
                                    </h6>
                                    <span class="badge bg-{{ 'danger' if recomendacion.prioridad == 'alta' else 'warning' if recomendacion.prioridad == 'media' else 'secondary' }}">
                                        {{ recomendacion.prioridad|upper }}
                                    </span>
                                </div>
                                <p class="card-text">{{ recomendacion.contenido }}</p>
                                {% if recomendacion.acciones %}
                                <div class="mt-3">
                                    <h6 class="text-primary">Acciones Recomendadas:</h6>
                                    <ul class="list-unstyled">
                                        {% for accion in recomendacion.acciones %}
                                        <li><i class="fas fa-arrow-right text-primary"></i> {{ accion }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Contradicciones Internas -->
                {% if resultado.analisis_discrepancias and resultado.analisis_discrepancias.contradicciones_internas %}
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-circle"></i> Contradicciones Internas Detectadas
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for contradiccion in resultado.analisis_discrepancias.contradicciones_internas %}
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title text-secondary">
                                    <i class="fas fa-times-circle"></i> Contradicción Interna
                                </h6>
                                <p class="card-text">{{ contradiccion.descripcion }}</p>
                                <div class="context-text">
                                    <strong>Texto detectado:</strong><br>
                                    {{ contradiccion.texto }}
                                </div>
                                <div class="mt-2">
                                    <h6 class="text-primary">Argumento:</h6>
                                    <p class="text-muted">{{ contradiccion.argumento }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Información del Archivo -->
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-file"></i> Información del Archivo
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Archivo:</strong> {{ resultado.nombre_archivo }}</p>
                                <p><strong>Procesado:</strong> {{ resultado.timestamp }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Longitud del texto:</strong> {{ resultado.longitud_texto }} caracteres</p>
                                <p><strong>Método de análisis:</strong> {{ resultado.metodo_analisis }}</p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-success flex-fill" onclick="descargarInforme()">
                                        <i class="fas fa-download"></i> <span class="d-none d-sm-inline">Descargar </span>Informe Completo
                                    </button>
                                    <button class="btn btn-info flex-fill" onclick="descargarResumen()">
                                        <i class="fas fa-file-pdf"></i> <span class="d-none d-sm-inline">Descargar </span>Resumen PDF
                                    </button>
                                    <button class="btn btn-warning flex-fill" onclick="imprimirInforme()">
                                        <i class="fas fa-print"></i> <span class="d-none d-sm-inline">Imprimir </span>Informe
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    No se encontraron datos de análisis de discrepancias para mostrar.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Datos para JavaScript -->
    <script type="application/json" id="datos-analisis">
        {{ resultado | tojson | safe }}
    </script>
    
    <script>
        // Variables globales para JavaScript
        const datosAnalisis = JSON.parse(document.getElementById('datos-analisis').textContent);
        
        const discrepancias = datosAnalisis.analisis_discrepancias?.discrepancias_detectadas || [];
        const evidencia = datosAnalisis.analisis_discrepancias?.evidencia_favorable || [];
        const argumentos = datosAnalisis.analisis_discrepancias?.argumentos_juridicos || [];
        const recomendaciones = datosAnalisis.analisis_discrepancias?.recomendaciones_defensa || [];
        
        // Poblar métricas del dashboard inmediatamente
        function actualizarMetricas() {
            try {
                // Debug: verificar que los elementos existen
                const elemDiscrepancias = document.getElementById('metric-discrepancias');
                const elemEvidencia = document.getElementById('metric-evidencia');
                const elemPuntuacion = document.getElementById('metric-puntuacion');
                const elemProbabilidad = document.getElementById('metric-probabilidad');
                
                // Actualizar métricas del dashboard
                if (elemDiscrepancias) elemDiscrepancias.textContent = discrepancias.length;
                if (elemEvidencia) elemEvidencia.textContent = evidencia.length;
                if (elemPuntuacion) elemPuntuacion.textContent = (datosAnalisis.analisis_discrepancias?.puntuacion_discrepancia || 0) + '/100';
                if (elemProbabilidad) elemProbabilidad.textContent = ((datosAnalisis.analisis_discrepancias?.probabilidad_ipp || 0) * 100).toFixed(1) + '%';
                
            } catch (e) {
                console.log('Error actualizando métricas:', e);
                // Reintentar después de un pequeño delay
                setTimeout(actualizarMetricas, 100);
            }
        }
        
        // Ejecutar cuando la página esté completamente cargada con delay
        window.onload = function() {
            setTimeout(actualizarMetricas, 500); // 500ms de delay para asegurar renderizado completo
        };
        
        // También ejecutar inmediatamente y en DOMContentLoaded por si acaso
        actualizarMetricas();
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(actualizarMetricas, 200);
        });
        
        // Función para descargar informe completo en formato Word
        function descargarInforme() {
            try {
                const datos = {
                    nombre_archivo: datosAnalisis.nombre_archivo,
                    analisis_discrepancias: datosAnalisis.analisis_discrepancias,
                    timestamp: datosAnalisis.timestamp
                };
                
                fetch('/api/descargar-informe-discrepancias', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datos)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al generar el informe');
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `informe_discrepancias_{{ resultado.nombre_archivo.replace('.pdf', '') }}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                    
                    // Mostrar notificación de éxito
                    mostrarNotificacion('Informe descargado exitosamente', 'success');
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarNotificacion('Error al descargar el informe: ' + error.message, 'danger');
                });
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error: ' + error.message, 'danger');
            }
        }
        
        // Función para descargar resumen en PDF
        function descargarResumen() {
            try {
                // Crear contenido HTML para el PDF
                const contenido = generarContenidoResumen();
                
                fetch('/api/descargar-resumen-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contenido: contenido,
                        nombre_archivo: "{{ resultado.nombre_archivo }}"
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al generar el PDF');
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `resumen_discrepancias_{{ resultado.nombre_archivo.replace('.pdf', '') }}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                    
                    mostrarNotificacion('Resumen PDF descargado exitosamente', 'success');
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarNotificacion('Error al descargar el PDF: ' + error.message, 'danger');
                });
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error: ' + error.message, 'danger');
            }
        }
        
        // Función para imprimir el informe
        function imprimirInforme() {
            try {
                // Crear ventana de impresión
                const ventanaImpresion = window.open('', '_blank');
                const contenido = generarContenidoImpresion();
                
                ventanaImpresion.document.write(contenido);
                ventanaImpresion.document.close();
                ventanaImpresion.focus();
                ventanaImpresion.print();
                ventanaImpresion.close();
                
                mostrarNotificacion('Ventana de impresión abierta', 'info');
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al imprimir: ' + error.message, 'danger');
            }
        }
        
        // Función para generar contenido del resumen
        function generarContenidoResumen() {
            // Usar las variables globales ya definidas
            
            let contenido = `
                <h1>ANÁLISIS DE DISCREPANCIAS MÉDICAS-LEGALES</h1>
                <h2>Archivo: ${datosAnalisis.nombre_archivo}</h2>
                <p><strong>Fecha de análisis:</strong> ${datosAnalisis.timestamp}</p>
                
                <h3>RESUMEN EJECUTIVO</h3>
                <ul>
                    <li>Discrepancias detectadas: ${discrepancias.length}</li>
                    <li>Evidencia favorable: ${evidencia.length} elementos</li>
                    <li>Puntuación discrepancia: {{ resultado.analisis_discrepancias.puntuacion_discrepancia if resultado.analisis_discrepancias and resultado.analisis_discrepancias.puntuacion_discrepancia else 0 }}/100</li>
                    <li>Probabilidad IPP: {{ (resultado.analisis_discrepancias.probabilidad_ipp * 100) | round(1) if resultado.analisis_discrepancias and resultado.analisis_discrepancias.probabilidad_ipp else 0 }}%</li>
                </ul>
                
                <h3>DISCREPANCIAS DETECTADAS</h3>
            `;
            
            discrepancias.forEach((disc, index) => {
                contenido += `
                    <h4>${index + 1}. ${(disc.tipo || 'Discrepancia').replace('_', ' ').toUpperCase()}</h4>
                    <p><strong>Descripción:</strong> ${disc.descripcion || disc}</p>
                    <p><strong>Severidad:</strong> ${disc.severidad || 'MEDIA'}</p>
                    <p><strong>Argumento:</strong> ${disc.argumento_juridico || disc.argumento || 'No disponible'}</p>
                `;
            });
            
            contenido += `
                <h3>EVIDENCIA FAVORABLE</h3>
            `;
            
            evidencia.forEach((ev, index) => {
                contenido += `
                    <h4>${index + 1}. ${(ev.tipo || 'Evidencia').replace('_', ' ').toUpperCase()}</h4>
                    <p><strong>Descripción:</strong> ${ev.descripcion || ev}</p>
                    <p><strong>Relevancia:</strong> ${ev.relevancia || 'MEDIA'}</p>
                    <p><strong>Argumento:</strong> ${ev.argumento || 'No disponible'}</p>
                `;
            });
            
            contenido += `
                <h3>ARGUMENTOS JURÍDICOS</h3>
            `;
            
            argumentos.forEach((arg, index) => {
                contenido += `
                    <h4>${index + 1}. ${arg.titulo || arg || 'Argumento'}</h4>
                    <p><strong>Contenido:</strong> ${arg.contenido || arg}</p>
                    <p><strong>Fuerza:</strong> ${arg.fuerza || 'MEDIA'}</p>
                `;
            });
            
            contenido += `
                <h3>RECOMENDACIONES DE DEFENSA</h3>
            `;
            
            recomendaciones.forEach((rec, index) => {
                contenido += `
                    <h4>${index + 1}. ${rec.titulo || rec.tipo || rec || 'Recomendación'}</h4>
                    <p><strong>Contenido:</strong> ${rec.contenido || rec.descripcion || rec}</p>
                    <p><strong>Prioridad:</strong> ${rec.prioridad || rec.nivel || 'MEDIA'}</p>
                `;
                if (rec.acciones && rec.acciones.length > 0) {
                    contenido += `<p><strong>Acciones:</strong></p><ul>`;
                    rec.acciones.forEach(accion => {
                        contenido += `<li>${accion}</li>`;
                    });
                    contenido += `</ul>`;
                }
            });
            
            return contenido;
        }
        
        // Función para generar contenido de impresión
        function generarContenidoImpresion() {
            const contenido = generarContenidoResumen();
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Análisis de Discrepancias - {{ resultado.nombre_archivo }}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #333; border-bottom: 2px solid #333; }
                        h2 { color: #666; }
                        h3 { color: #888; margin-top: 30px; }
                        h4 { color: #999; margin-top: 20px; }
                        ul { margin-left: 20px; }
                        p { margin: 10px 0; }
                        .page-break { page-break-before: always; }
                    </style>
                </head>
                <body>
                    ${contenido}
                </body>
                </html>
            `;
        }
        
        // Función para mostrar notificaciones
        function mostrarNotificacion(mensaje, tipo) {
            // Crear elemento de notificación
            const notificacion = document.createElement('div');
            notificacion.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
            notificacion.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notificacion.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notificacion);
            
            // Auto-remover después de 5 segundos
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.parentNode.removeChild(notificacion);
                }
            }, 5000);
        }
    </script>
</body>
</html>

